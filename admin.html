<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="animated-bg"></div>
    <div class="floating-orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
        <div class="orb orb3"></div>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">STEELCONNECT</div>
                <div class="logo-subtitle">Admin Portal</div>
            </div>
            <nav class="nav-menu">
                <button class="tab active" onclick="showTab('overview')"><i class="fas fa-home"></i> Overview</button>
                <button class="tab" onclick="showTab('users')"><i class="fas fa-users"></i> Users</button>
                <button class="tab" onclick="showTab('jobs')"><i class="fas fa-briefcase"></i> Jobs</button>
                <button class="tab" onclick="showTab('quotes')"><i class="fas fa-file-invoice-dollar"></i> Quotes</button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                    <span class="notification-badge" id="estimationBadge" style="display:none;">0</span>
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                    <span class="notification-badge" id="messageBadge" style="display:none;">0</span>
                </button>
                <button class="tab" onclick="showTab('subscriptions')"><i class="fas fa-credit-card"></i> Subscriptions</button>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <div class="header-actions">
                    <div class="admin-badge">
                        <i class="fas fa-user-shield"></i>
                        <span id="adminName">Admin</span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="loading"><div class="spinner"></div><p>Loading dashboard statistics...</p></div>
            </div>

            <div class="section">
                <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
                <div id="overview-tab" class="tab-content active"><div class="loading"><div class="spinner"></div><p>Loading overview data...</p></div></div>
                <div id="users-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading users data...</p></div></div>
                <div id="jobs-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading jobs data...</p></div></div>
                <div id="quotes-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading quotes data...</p></div></div>
                <div id="estimations-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading estimations data...</p></div></div>
                <div id="messages-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading messages data...</p></div></div>
                <div id="subscriptions-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading subscriptions data...</p></div></div>
            </div>
        </main>
    </div>

    <div class="fab" onclick="refreshAllData()">
        <i class="fas fa-sync-alt"></i>
    </div>

    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>View Estimation Files</h3>
                <button class="close" onclick="closeModal('pdfModal')">&times;</button>
            </div>
            <div class="pdf-viewer-container">
                <div class="pdf-viewer-header">
                    <h4 id="pdfFileName">Document</h4>
                    <div class="pdf-viewer-controls">
                        <button class="btn btn-sm" onclick="previousPDF()"><i class="fas fa-arrow-left"></i> Previous</button>
                        <span id="pdfPageInfo">1 / 1</span>
                        <button class="btn btn-sm" onclick="nextPDF()">Next <i class="fas fa-arrow-right"></i></button>
                        <button class="btn btn-info btn-sm" onclick="downloadCurrentPDF()"><i class="fas fa-download"></i> Download</button>
                    </div>
                </div>
                <iframe id="pdfViewer" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Conversation Messages</h3>
                <button class="close" onclick="closeModal('messagesModal')">&times;</button>
            </div>
            <div id="messagesContent">
                <div class="loading"><div class="spinner"></div><p>Loading messages...</p></div>
            </div>
            <div class="message-reply-box" id="replyBox" style="display:none;">
                <textarea class="message-input" id="replyMessage" placeholder="Type your message here..."></textarea>
                <button class="btn btn-success" onclick="sendReply()"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </div>
        </div>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Estimation Status</h3>
                <button class="close" onclick="closeModal('statusModal')">&times;</button>
            </div>
            <form id="statusForm">
                <div class="form-group">
                    <label for="statusSelect">New Status:</label>
                    <select id="statusSelect" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (Optional):</label>
                    <textarea id="statusNotes" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let currentTab = 'overview';
        let currentPDFIndex = 0;
        let currentPDFs = [];
        let currentConversationId = null;
        let currentEstimationId = null;

        // Get authentication token from localStorage or sessionStorage
        function getToken() {
            return localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
        }

        // Make an authenticated API call
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            if (!token) {
                // Redirect to login if no token is found
                window.location.href = 'index.html'; 
                return;
            }

            const config = {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                if (response.status === 401) { // Handle unauthorized access
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Load main dashboard statistics
        async function loadDashboardStats() {
            try {
                const data = await apiCall('/admin/dashboard');
                dashboardData = data.data;
                document.getElementById('adminName').textContent = dashboardData.adminUser ? dashboardData.adminUser.split('@')[0] : 'Admin';
                renderStatsGrid(dashboardData.stats);
                updateNotificationBadges();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = '<div class="error">Failed to load dashboard statistics.</div>';
            }
        }

        // Render the main stats grid with animations
        function renderStatsGrid(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-content"><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div></div>
                <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div class="stat-content"><div class="stat-number">${stats.contractors || 0}</div><div class="stat-label">Contractors</div></div></div>
                <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div class="stat-content"><div class="stat-number">${stats.designers || 0}</div><div class="stat-label">Designers</div></div></div>
                <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div class="stat-content"><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div></div>
                <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div class="stat-content"><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div></div>
                <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div class="stat-content"><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div></div>
                <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div><div class="stat-content"><div class="stat-number">${stats.totalSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div></div>
                <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-comments"></i></div><div class="stat-content"><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div></div>
            `;
            animateStats();
        }

        // Animate the numbers in the stats cards
        function animateStats() {
            document.querySelectorAll('.stat-number').forEach(element => {
                const target = parseInt(element.textContent, 10);
                let current = 0;
                const increment = Math.max(1, target / 50);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.textContent = target;
                        clearInterval(timer);
                    } else {
                        element.textContent = Math.floor(current);
                    }
                }, 20);
            });
        }
        
        // Update notification badges for new messages and estimations
        function updateNotificationBadges() {
            const estimationBadge = document.getElementById('estimationBadge');
            if (dashboardData.stats?.pendingEstimations > 0) {
                estimationBadge.textContent = dashboardData.stats.pendingEstimations;
                estimationBadge.style.display = 'inline-block';
            } else {
                estimationBadge.style.display = 'none';
            }
            
            const messageBadge = document.getElementById('messageBadge');
            if (dashboardData.stats?.unreadMessages > 0) {
                messageBadge.textContent = dashboardData.stats.unreadMessages;
                messageBadge.style.display = 'inline-block';
            } else {
                messageBadge.style.display = 'none';
            }
        }
        
        // Handle tab switching and loading data for the selected tab
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            currentTab = tabName;
            
            switch(tabName) {
                case 'overview': renderOverviewTab(); break;
                case 'users': loadUsersData(); break;
                case 'jobs': loadJobsData(); break;
                case 'quotes': loadQuotesData(); break;
                case 'estimations': loadEstimationsData(); break;
                case 'messages': loadMessagesData(); break;
                case 'subscriptions': loadSubscriptionsData(); break;
            }
        }

        // Render the content for the overview tab
        function renderOverviewTab() {
            document.getElementById('overview-tab').innerHTML = `
                <div class="success"><h3><i class="fas fa-check-circle"></i> System Status: All Systems Operational</h3><p>Your SteelConnect admin panel is running smoothly.</p></div>
                <div class="quick-stats-container">
                    <h3><i class="fas fa-chart-line"></i> Quick Stats</h3>
                    <div class="quick-stats-grid">
                        <div class="quick-stat"><strong style="color: #6366f1;">Active Jobs:</strong> <span>${dashboardData.stats?.activeJobs || 0}</span></div>
                        <div class="quick-stat"><strong style="color: #22c55e;">Completed Jobs:</strong> <span>${dashboardData.stats?.completedJobs || 0}</span></div>
                        <div class="quick-stat"><strong style="color: #f59e0b;">Pending Estimations:</strong> <span>${dashboardData.stats?.pendingEstimations || 0}</span></div>
                        <div class="quick-stat"><strong style="color: #ec4899;">Active Subscriptions:</strong> <span>${dashboardData.stats?.activeSubscriptions || 0}</span></div>
                    </div>
                </div>`;
        }
        
        // Load and render estimations data
        async function loadEstimationsData() {
            const estimationsTab = document.getElementById('estimations-tab');
            try {
                const data = await apiCall('/estimation');
                const estimations = data.estimations || [];
                if (estimations.length === 0) {
                    estimationsTab.innerHTML = '<div class="no-data"><i class="fas fa-folder-open"></i>No estimations found.</div>';
                    return;
                }
                estimationsTab.innerHTML = `
                    <h3><i class="fas fa-calculator"></i> All Estimations (${estimations.length})</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Amount</th><th>Date</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${estimations.map(est => `
                                    <tr>
                                        <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                                        <td>${est.contractorName || 'N/A'}</td>
                                        <td><span class="status-badge ${est.status}">${est.status}</span></td>
                                        <td>${est.uploadedFiles?.length || 0} file(s)</td>
                                        <td>${est.estimatedAmount ? `â‚¹${est.estimatedAmount.toLocaleString()}` : 'Pending'}</td>
                                        <td>${new Date(est.createdAt).toLocaleDateString()}</td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn btn-sm btn-info" onclick="viewEstimationPDF('${est._id}')"><i class="fas fa-file-pdf"></i> View Files</button>
                                                <button class="btn btn-sm" onclick="openStatusModal('${est._id}', '${est.status}')"><i class="fas fa-edit"></i> Update</button>
                                            </div>
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
            } catch (error) {
                estimationsTab.innerHTML = `<div class="error">Failed to load estimations: ${error.message}</div>`;
            }
        }
        
        // Load and display PDF files for an estimation
        async function viewEstimationPDF(estimationId) {
            try {
                const data = await apiCall(`/estimation/${estimationId}/files`);
                currentPDFs = data.files.filter(file => file.url && (file.contentType === 'application/pdf' || file.url.toLowerCase().endsWith('.pdf')));
                
                if (currentPDFs.length === 0) {
                    alert('No viewable PDF files found for this estimation.');
                    return;
                }
                
                currentPDFIndex = 0;
                displayPDF();
                document.getElementById('pdfModal').style.display = 'block';
            } catch (error) {
                alert('Failed to load PDF files: ' + error.message);
            }
        }

        // Helper function to display the current PDF in the modal
        function displayPDF() {
            if (currentPDFs.length === 0) return;
            const pdf = currentPDFs[currentPDFIndex];
            document.getElementById('pdfViewer').src = pdf.url;
            document.getElementById('pdfFileName').textContent = pdf.name || 'Document';
            document.getElementById('pdfPageInfo').textContent = `${currentPDFIndex + 1} / ${currentPDFs.length}`;
        }
        function previousPDF() { if (currentPDFIndex > 0) { currentPDFIndex--; displayPDF(); } }
        function nextPDF() { if (currentPDFIndex < currentPDFs.length - 1) { currentPDFIndex++; displayPDF(); } }
        function downloadCurrentPDF() { if (currentPDFs.length > 0) window.open(currentPDFs[currentPDFIndex].url, '_blank'); }

        // Open the modal to update an estimation's status
        function openStatusModal(estimationId, currentStatus) {
            currentEstimationId = estimationId;
            document.getElementById('statusSelect').value = currentStatus;
            document.getElementById('statusNotes').value = '';
            document.getElementById('statusModal').style.display = 'block';
        }

        // Load and render conversations
        async function loadMessagesData() {
            const messagesTab = document.getElementById('messages-tab');
            try {
                const data = await apiCall('/messages');
                const conversations = data.data || [];
                if (conversations.length === 0) {
                    messagesTab.innerHTML = '<div class="no-data"><i class="fas fa-comments-dollar"></i>No conversations found.</div>';
                    return;
                }
                messagesTab.innerHTML = `
                    <h3><i class="fas fa-comments"></i> Conversations (${conversations.length})</h3>
                    <div class="conversation-list">
                        ${conversations.map(conv => `
                            <div class="conversation-item" onclick="viewConversation('${conv.id}')">
                                <div class="conversation-header">
                                    <div class="conversation-title">${conv.jobTitle || 'General Inquiry'}</div>
                                    <div class="conversation-time">${new Date(conv.updatedAt.seconds * 1000).toLocaleDateString()}</div>
                                </div>
                                <div class="conversation-preview"><strong>Participants:</strong> ${conv.participants?.map(p => p.name).join(', ') || 'N/A'}</div>
                                <div class="conversation-preview"><strong>Last:</strong> ${conv.lastMessage || 'No messages yet.'}</div>
                            </div>`).join('')}
                    </div>`;
            } catch (error) {
                messagesTab.innerHTML = `<div class="error">Failed to load messages: ${error.message}</div>`;
            }
        }

        // View messages within a specific conversation
        async function viewConversation(conversationId) {
            currentConversationId = conversationId;
            const messagesContent = document.getElementById('messagesContent');
            const replyBox = document.getElementById('replyBox');
            messagesContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading messages...</p></div>';
            document.getElementById('messagesModal').style.display = 'block';

            try {
                const data = await apiCall(`/messages/${conversationId}/messages`);
                const messages = data.data || [];

                if (messages.length === 0) {
                    messagesContent.innerHTML = '<div class="no-data">No messages in this conversation.</div>';
                    replyBox.style.display = 'block'; // Still allow sending the first message
                    return;
                }

                messagesContent.innerHTML = `<div class="messages-container">
                    ${messages.map(msg => `
                        <div class="message">
                            <div class="message-header">
                                ${msg.senderName || 'Unknown'}
                                <span class="message-time">${new Date(msg.createdAt.seconds * 1000).toLocaleString()}</span>
                            </div>
                            <div class="message-text">${msg.text || ''}</div>
                        </div>`).join('')}
                </div>`;
                replyBox.style.display = 'block';
                const container = messagesContent.querySelector('.messages-container');
                if (container) container.scrollTop = container.scrollHeight;
            } catch (error) {
                messagesContent.innerHTML = `<div class="error">Failed to load conversation: ${error.message}</div>`;
                replyBox.style.display = 'none';
            }
        }

        // Send a reply message in a conversation
        async function sendReply() {
            const messageInput = document.getElementById('replyMessage');
            const text = messageInput.value.trim();
            if (!text) { alert('Please enter a message.'); return; }

            try {
                await apiCall(`/messages/${currentConversationId}/send`, {
                    method: 'POST',
                    body: JSON.stringify({ text })
                });
                messageInput.value = '';
                viewConversation(currentConversationId); // Refresh conversation
            } catch (error) {
                alert('Failed to send message: ' + error.message);
            }
        }

        // Placeholder functions for other tabs
        function loadUsersData() { document.getElementById('users-tab').innerHTML = `<h3><i class="fas fa-users"></i> All Users</h3><div class="no-data">User management is under development.</div>`; }
        function loadJobsData() { document.getElementById('jobs-tab').innerHTML = `<h3><i class="fas fa-briefcase"></i> All Jobs</h3><div class="no-data">Job management is under development.</div>`; }
        function loadQuotesData() { document.getElementById('quotes-tab').innerHTML = `<h3><i class="fas fa-file-invoice-dollar"></i> All Quotes</h3><div class="no-data">Quote management is under development.</div>`; }
        function loadSubscriptionsData() { document.getElementById('subscriptions-tab').innerHTML = `<h3><i class="fas fa-credit-card"></i> Subscriptions</h3><div class="no-data">Subscription management is under development.</div>`; }

        // General utility functions
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
        function refreshAllData() {
            const fabIcon = document.querySelector('.fab i');
            fabIcon.classList.add('fa-spin');
            loadDashboardStats();
            if(currentTab) showTab(currentTab);
            setTimeout(() => fabIcon.classList.remove('fa-spin'), 1000);
        }

        // Event listener for the status update form
        document.getElementById('statusForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const status = document.getElementById('statusSelect').value;
            const notes = document.getElementById('statusNotes').value;
            
            try {
                await apiCall(`/estimation/${currentEstimationId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status, notes })
                });
                alert('Status updated successfully!');
                closeModal('statusModal');
                loadEstimationsData(); // Refresh estimations tab
                loadDashboardStats(); // Refresh dashboard stats
            } catch (error) {
                alert('Failed to update status: ' + error.message);
            }
        });

        // Initial application load
        document.addEventListener('DOMContentLoaded', () => {
            if (!getToken()) {
                // For demonstration, we'll stay on the page. In production, this would redirect.
                // window.location.href = 'index.html'; 
                console.warn("No auth token found. In a real app, you would be redirected to login.");
            }
            loadDashboardStats();
            showTab('overview');
        });
    </script>
</body>
</html>
