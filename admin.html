<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            <div class="header-actions">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Loading...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard statistics...</p>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="tab" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab" onclick="showTab('jobs')">
                    <i class="fas fa-briefcase"></i> Jobs
                </button>
                <button class="tab" onclick="showTab('quotes')">
                    <i class="fas fa-file-invoice-dollar"></i> Quotes
                </button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                </button>
                <button class="tab" onclick="showTab('subscriptions')">
                    <i class="fas fa-credit-card"></i> Subscriptions
                </button>
            </div>
            
            <div id="overview-tab" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading overview data...</p>
                </div>
            </div>
            
            <div id="users-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading users data...</p>
                </div>
            </div>
            
            <div id="jobs-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading jobs data...</p>
                </div>
            </div>
            
            <div id="quotes-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading quotes data...</p>
                </div>
            </div>
            
            <div id="estimations-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading estimations data...</p>
                </div>
            </div>
            
            <div id="messages-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages data...</p>
                </div>
            </div>
            
            <div id="subscriptions-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading subscriptions data...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Estimation Status</h3>
                <span class="close" onclick="closeModal('statusModal')">&times;</span>
            </div>
            <form id="statusForm">
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (Optional):</label>
                    <textarea id="statusNotes" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Estimation Result</h3>
                <span class="close" onclick="closeModal('uploadResultModal')">&times;</span>
            </div>
            <form id="uploadResultForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Result File (PDF):</label>
                    <div class="file-upload-area" id="resultUploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                        <p>Click to select or drag and drop your result file here</p>
                        <input type="file" id="resultFile" accept=".pdf" style="display: none;">
                    </div>
                    <div id="uploadedResultFiles" class="uploaded-files"></div>
                </div>
                <div class="form-group">
                    <label for="estimationAmount">Estimated Amount ($):</label>
                    <input type="number" id="estimationAmount" step="0.01" placeholder="Enter estimation amount">
                </div>
                <div class="form-group">
                    <label for="resultNotes">Notes (Optional):</label>
                    <textarea id="resultNotes" placeholder="Add any notes about this estimation..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadResultModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Upload Result</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Subscription Plan</h3>
                <span class="close" onclick="closeModal('createPlanModal')">&times;</span>
            </div>
            <form id="createPlanForm">
                <div class="form-group">
                    <label for="planName">Plan Name:</label>
                    <input type="text" id="planName" required placeholder="e.g., Premium Plan">
                </div>
                <div class="form-group">
                    <label for="planPrice">Price ($):</label>
                    <input type="number" id="planPrice" step="0.01" required placeholder="29.99">
                </div>
                <div class="form-group">
                    <label for="planInterval">Billing Interval:</label>
                    <select id="planInterval" required>
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planDescription">Description:</label>
                    <textarea id="planDescription" placeholder="Plan description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Features:</label>
                    <div id="featuresContainer">
                        <div class="feature-input">
                            <input type="text" placeholder="Feature 1">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeFeature(this)">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addFeature()">
                        <i class="fas fa-plus"></i> Add Feature
                    </button>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createPlanModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Plan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messagesModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="messagesModalTitle">Conversation Messages</h3>
                <span class="close" onclick="closeModal('messagesModal')">&times;</span>
            </div>
            <div id="messagesContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="filesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Estimation Files</h3>
                <span class="close" onclick="closeModal('filesModal')">&times;</span>
            </div>
            <div id="filesContent">
                </div>
        </div>
    </div>


    <script>
        console.log('🏗️ SteelConnect Admin Dashboard loaded');
        
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let usersData = [];
        let jobsData = [];
        let quotesData = [];
        let estimationsData = [];
        let messagesData = [];
        let subscriptionsData = [];
        let subscriptionPlans = [];
        let currentEstimationId = null;
        
        function getToken() {
            return localStorage.getItem('adminToken') || 
                   localStorage.getItem('token') || 
                   sessionStorage.getItem('adminToken');
        }
        
        // CORRECTED: apiCall function with better error handling for 401 Unauthorized
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            
            if (!token) {
                console.error('No authentication token found. Logging out.');
                logout(false);
                throw new Error('No authentication token found');
            }
            
            const config = {
                headers: { 'Authorization': `Bearer ${token}` },
                ...options
            };

            if (!(options.body instanceof FormData)) {
                config.headers['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                // Instead of logging out immediately, throw an error to be handled by the caller.
                // This prevents the entire app from breaking if one endpoint fails authentication.
                console.error(`Unauthorized (401) access for endpoint: ${endpoint}`);
                throw new Error('Unauthorized access. Your session may have expired.');
            }
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}: ${response.statusText}` }));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        async function loadDashboardStats() {
            try {
                console.log('📊 Loading dashboard statistics...');
                const data = await apiCall('/admin/dashboard');
                dashboardData = data.data;
                console.log('✅ Dashboard data loaded:', dashboardData);
                const adminName = document.getElementById('adminName');
                if (adminName && dashboardData.adminUser) {
                    adminName.textContent = dashboardData.adminUser.split('@')[0];
                }
                renderStatsGrid(dashboardData.stats);
            } catch (error) {
                console.error('❌ Error loading dashboard:', error);
                document.getElementById('statsGrid').innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Failed to load dashboard: ${error.message}</div>`;
            }
        }
        
        function renderStatsGrid(stats) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div>
                <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div class="stat-number">${stats.contractors || 0}</div><div class="stat-label">Contractors</div></div>
                <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div class="stat-number">${stats.designers || 0}</div><div class="stat-label">Designers</div></div>
                <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div>
                <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div>
                <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div>
                <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div><div class="stat-number">${stats.totalSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div>
                <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-comments"></i></div><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div>`;
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[onclick*="showTab('${tabName}')"]`).classList.add('active');
            
            const dataMap = { users: usersData, jobs: jobsData, quotes: quotesData, estimations: estimationsData, messages: messagesData, subscriptions: subscriptionsData };
            const loadMap = { users: loadUsersData, jobs: loadJobsData, quotes: loadQuotesData, estimations: loadEstimationsData, messages: loadMessagesData, subscriptions: loadSubscriptionsData, overview: renderOverviewTab };
            
            if (tabName !== 'overview' && dataMap[tabName].length === 0) {
                loadMap[tabName]();
            } else if (tabName === 'overview') {
                loadMap[tabName]();
            }
        }
        
        async function loadUsersData() {
            try {
                console.log('👥 Loading users data...');
                usersData = (await apiCall('/admin/users')).data;
                renderUsersTab();
            } catch (error) {
                document.getElementById('users-tab').innerHTML = `<div class="error">Failed to load users: ${error.message}</div>`;
            }
        }
        
        function renderUsersTab() {
            const content = usersData.length === 0 ? '<div class="no-data">No users found</div>' : `
                <h3><i class="fas fa-users"></i> All Users (${usersData.length})</h3>
                <table><thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Status</th><th>Joined</th></tr></thead>
                <tbody>${usersData.map(user => `
                    <tr><td><strong>${user.name || 'N/A'}</strong></td><td>${user.email}</td><td><span class="user-type ${user.type}">${user.type.toUpperCase()}</span></td><td>${user.status || 'Active'}</td><td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td></tr>`).join('')}
                </tbody></table>`;
            document.getElementById('users-tab').innerHTML = content;
        }
        
        async function loadJobsData() {
            try {
                console.log('💼 Loading jobs data...');
                jobsData = (await apiCall('/admin/jobs')).data;
                renderJobsTab();
            } catch (error) {
                document.getElementById('jobs-tab').innerHTML = `<div class="error">Failed to load jobs: ${error.message}</div>`;
            }
        }
        
        function renderJobsTab() {
            const content = jobsData.length === 0 ? '<div class="no-data">No jobs found</div>' : `
                <h3><i class="fas fa-briefcase"></i> All Jobs (${jobsData.length})</h3>
                <table><thead><tr><th>Title</th><th>Posted By</th><th>Budget</th><th>Status</th><th>Quotes</th><th>Posted</th></tr></thead>
                <tbody>${jobsData.map(job => `
                    <tr><td><strong>${job.title || 'Untitled'}</strong></td><td>${job.posterName || 'Unknown'}</td><td>${job.budget || '0'}</td><td><span class="status-badge ${job.status}">${job.status.toUpperCase()}</span></td><td>${job.quotesCount || 0}</td><td>${job.createdAt ? new Date(job.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td></tr>`).join('')}
                </tbody></table>`;
            document.getElementById('jobs-tab').innerHTML = content;
        }
        
        async function loadQuotesData() {
            try {
                console.log('💰 Loading quotes data...');
                quotesData = (await apiCall('/admin/quotes')).data;
                renderQuotesTab();
            } catch (error) {
                document.getElementById('quotes-tab').innerHTML = `<div class="error">Failed to load quotes: ${error.message}</div>`;
            }
        }
        
        function renderQuotesTab() {
            const content = quotesData.length === 0 ? '<div class="no-data">No quotes found</div>' : `
                <h3><i class="fas fa-file-invoice-dollar"></i> All Quotes (${quotesData.length})</h3>
                <table><thead><tr><th>Job</th><th>Designer</th><th>Amount</th><th>Timeline</th><th>Status</th><th>Submitted</th></tr></thead>
                <tbody>${quotesData.map(quote => `
                    <tr><td><strong>${quote.jobTitle || 'Unknown Job'}</strong></td><td>${quote.designerName || 'Unknown'}</td><td>${quote.quoteAmount || '0'}</td><td>${quote.timeline ? quote.timeline + ' days' : 'N/A'}</td><td><span class="status-badge ${quote.status}">${quote.status.toUpperCase()}</span></td><td>${quote.createdAt ? new Date(quote.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td></tr>`).join('')}
                </tbody></table>`;
            document.getElementById('quotes-tab').innerHTML = content;
        }
        
        async function loadEstimationsData() {
            try {
                console.log('🧮 Loading estimations data...');
                estimationsData = (await apiCall('/admin/estimations')).estimations || [];
                console.log('✅ Estimations data loaded:', estimationsData.length, 'estimations');
                renderEstimationsTab();
            } catch (error) {
                console.error('❌ Error loading estimations:', error);
                document.getElementById('estimations-tab').innerHTML = `<div class="error">Failed to load estimations: ${error.message}</div>`;
            }
        }
        
        function renderEstimationsTab() {
            const content = estimationsData.length === 0 ? '<div class="no-data">No estimations found</div>' : `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-calculator"></i> All Estimations (${estimationsData.length})</h3>
                    <button class="btn" onclick="refreshEstimations()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <table><thead><tr><th>Project Title</th><th>Contractor</th><th>Status</th><th>Files</th><th>Amount</th><th>Submitted</th><th>Actions</th></tr></thead>
                <tbody>${estimationsData.map(est => `
                    <tr>
                        <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                        <td>${est.contractorName || 'Unknown'}</td>
                        <td><span class="status-badge ${est.status}">${est.status.toUpperCase()}</span></td>
                        <td>${est.uploadedFiles?.length || 0} files</td>
                        <td>${est.estimatedAmount ? '$' + est.estimatedAmount.toLocaleString() : 'Pending'}</td>
                        <td>${est.createdAt ? new Date(est.createdAt).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm" onclick="updateEstimationStatus('${est._id}')" title="Update Status"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-warning" onclick="showEstimationFilesModal('${est._id}')" title="View/Download Files"><i class="fas fa-file-alt"></i></button>
                                <button class="btn btn-sm btn-info" onclick="viewEstimationMessages('${est._id}')" title="View Messages"><i class="fas fa-comments"></i></button>
                                <button class="btn btn-sm btn-success" onclick="uploadEstimationResult('${est._id}')" title="Upload Result"><i class="fas fa-upload"></i></button>
                                ${est.status === 'completed' && est.resultFile ? `<button class="btn btn-sm" onclick="downloadResult('${est._id}')" title="Download Result"><i class="fas fa-download"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
            document.getElementById('estimations-tab').innerHTML = content;
        }
        
        // CORRECTED: loadMessagesData with robust error handling
        async function loadMessagesData() {
            try {
                console.log('💬 Loading messages data...');
                messagesData = (await apiCall('/admin/messages')).data || [];
                console.log('✅ Messages data loaded:', messagesData.length, 'conversations');
                renderMessagesTab();
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                document.getElementById('messages-tab').innerHTML = `
                    <div class="error">
                        Failed to load messages: ${error.message}
                        ${error.message.includes('Unauthorized') ? '<br>Please try logging out and back in. If the problem persists, check server permissions for this endpoint.' : ''}
                    </div>`;
            }
        }
        
        function renderMessagesTab() {
             const content = messagesData.length === 0 ? '<div class="no-data">No conversations found</div>' : `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-comments"></i> Conversations (${messagesData.length})</h3>
                    <button class="btn" onclick="refreshMessages()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="conversation-list">${messagesData.map(convo => `
                    <div class="conversation-item" onclick="viewConversation('${convo.id}')">
                        <div class="conversation-header">
                            <div class="conversation-title">${convo.jobTitle || 'Unknown Job'}</div>
                            <div class="conversation-time">${convo.updatedAt ? new Date(convo.updatedAt.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        <div class="conversation-preview"><strong>Participants:</strong> ${convo.participants?.map(p => p.name).join(', ') || 'Unknown'}</div>
                        <div class="conversation-preview"><strong>Last message:</strong> ${convo.lastMessage || 'No messages yet'}</div>
                    </div>`).join('')}
                </div>`;
            document.getElementById('messages-tab').innerHTML = content;
        }
        
        async function loadSubscriptionsData() {
            try {
                console.log('💳 Loading subscriptions data...');
                const [subsRes, plansRes] = await Promise.all([apiCall('/admin/subscriptions'), apiCall('/admin/subscription-plans')]);
                subscriptionsData = subsRes.subscriptions || [];
                subscriptionPlans = plansRes.plans || [];
                renderSubscriptionsTab();
            } catch (error) {
                document.getElementById('subscriptions-tab').innerHTML = `<div class="error">Failed to load subscriptions: ${error.message}</div>`;
            }
        }
        
        function renderSubscriptionsTab() {
            document.getElementById('subscriptions-tab').innerHTML = `
                <div class="subscriptions-management">
                    <div class="control-panel">
                        <h3><i class="fas fa-cogs"></i> System Controls</h3>
                        <div class="control-item"><div class="control-info"><h4>Jobs Module</h4><p>Enable or disable job posting and management</p></div><label class="toggle-switch"><input type="checkbox" id="jobsToggle" checked onchange="toggleSystemFeature('jobs', this.checked)"><span class="toggle-slider"></span></label></div>
                        <div class="control-item"><div class="control-info"><h4>User Registration</h4><p>Allow new users to register on the platform</p></div><label class="toggle-switch"><input type="checkbox" id="usersToggle" checked onchange="toggleSystemFeature('users', this.checked)"><span class="toggle-slider"></span></label></div>
                        <div class="control-item"><div class="control-info"><h4>Messaging System</h4><p>Enable or disable user messaging functionality</p></div><label class="toggle-switch"><input type="checkbox" id="messagesToggle" checked onchange="toggleSystemFeature('messages', this.checked)"><span class="toggle-slider"></span></label></div>
                        <div class="control-item"><div class="control-info"><h4>Estimation Requests</h4><p>Allow contractors to submit estimation requests</p></div><label class="toggle-switch"><input type="checkbox" id="estimationsToggle" checked onchange="toggleSystemFeature('estimations', this.checked)"><span class="toggle-slider"></span></label></div>
                    </div>
                    <div class="subscription-tabs">
                        <button class="tab-button active" onclick="switchSubscriptionTab('plans')"><i class="fas fa-layer-group"></i> Subscription Plans</button>
                        <button class="tab-button" onclick="switchSubscriptionTab('users')"><i class="fas fa-users"></i> User Subscriptions</button>
                        <button class="tab-button" onclick="switchSubscriptionTab('analytics')"><i class="fas fa-chart-bar"></i> Analytics</button>
                    </div>
                    <div id="plans-tab" class="tab-content active">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><div><h3>Subscription Plans</h3><span class="count-badge">${subscriptionPlans.length} plans</span></div><button class="btn btn-success" onclick="createSubscriptionPlan()"><i class="fas fa-plus"></i> Create New Plan</button></div>
                        <div class="plans-grid">${subscriptionPlans.length ? subscriptionPlans.map(plan => `<div class="plan-card"><div class="plan-header"><h4>${plan.name}</h4><div class="plan-price">$${plan.price}<small>/${plan.interval}</small></div></div><div class="plan-body"><div class="plan-description">${plan.description || ''}</div><div class="plan-features"><h5>Features:</h5><ul>${plan.features?.map(f => `<li><i class="fas fa-check"></i> ${f}</li>`).join('') || ''}</ul></div><div class="plan-stats"><div class="stat-item"><i class="fas fa-users"></i><span>${plan.subscriberCount || 0} subscribers</span></div></div></div><div class="plan-actions"><button class="btn btn-sm btn-info" onclick="editSubscriptionPlan('${plan._id}')"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-sm btn-danger" onclick="deleteSubscriptionPlan('${plan._id}')"><i class="fas fa-trash"></i> Delete</button></div></div>`).join('') : '<div class="empty-state"><i class="fas fa-layer-group"></i><h3>No subscription plans</h3></div>'}</div>
                    </div>
                    <div id="users-tab" class="tab-content">${/* User subscriptions content */}</div>
                    <div id="analytics-tab" class="tab-content">${/* Analytics content */}</div>
                </div>`;
        }
        
        function renderOverviewTab() {
            document.getElementById('overview-tab').innerHTML = `<div class="success"><h3><i class="fas fa-check-circle"></i> System Status: All Systems Operational</h3><p>Your SteelConnect admin panel is running smoothly.</p></div>`;
        }
        
        function updateEstimationStatus(estimationId) {
            currentEstimationId = estimationId;
            const est = estimationsData.find(e => e._id === estimationId);
            if (est) {
                document.getElementById('statusSelect').value = est.status;
                document.getElementById('statusNotes').value = '';
                document.getElementById('statusModal').style.display = 'block';
            }
        }

        // CORRECTED: showEstimationFilesModal to use existing data instead of a new API call
        function showEstimationFilesModal(estimationId) {
            const modal = document.getElementById('filesModal');
            const content = document.getElementById('filesContent');
            modal.style.display = 'block';

            const estimation = estimationsData.find(e => e._id === estimationId);
            
            if (!estimation || !estimation.uploadedFiles || estimation.uploadedFiles.length === 0) {
                content.innerHTML = '<div class="no-data">No files were uploaded for this estimation.</div>';
                return;
            }

            content.innerHTML = estimation.uploadedFiles.map(file => `
                <div class="file-list-item">
                    <div class="file-info-container">
                        <i class="fas fa-file-alt"></i>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <a href="${file.url}" download="${file.name}" class="download-link" target="_blank" rel="noopener noreferrer">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>`).join('');
        }

        async function viewEstimationMessages(estimationId) {
            const modal = document.getElementById('messagesModal');
            const content = document.getElementById('messagesContent');
            document.getElementById('messagesModalTitle').textContent = 'Estimation Messages';
            modal.style.display = 'block';
            content.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading messages...</p></div>`;
            try {
                const data = await apiCall(`/admin/estimations/${estimationId}/messages`);
                const messages = data.data || [];
                if (messages.length === 0) {
                    content.innerHTML = '<div class="no-data">No messages for this estimation.</div>';
                    return;
                }
                content.innerHTML = `<div class="messages-container">${messages.map(msg => `<div class="message"><div class="message-header">${msg.senderName || 'Unknown'}<span class="message-time">${msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString() : ''}</span></div><div class="message-text">${msg.text || ''}</div></div>`).join('')}</div>`;
            } catch (error) {
                content.innerHTML = `<div class="error">Failed to load messages: ${error.message}</div>`;
            }
        }
       
        function uploadEstimationResult(estimationId) {
            currentEstimationId = estimationId;
            document.getElementById('uploadResultForm').reset();
            document.getElementById('uploadedResultFiles').innerHTML = '';
            document.getElementById('uploadResultModal').style.display = 'block';
        }
       
        async function downloadResult(estimationId) {
            try {
                const data = await apiCall(`/admin/estimations/${estimationId}/result`);
                if (data.resultFile && data.resultFile.url) {
                    window.open(data.resultFile.url, '_blank');
                } else {
                    alert('No result file available.');
                }
            } catch (error) {
                alert('Failed to download result: ' + error.message);
            }
        }
       
        async function viewConversation(conversationId) {
            document.getElementById('messagesModalTitle').textContent = 'Conversation Messages';
            const modal = document.getElementById('messagesModal');
            const content = document.getElementById('messagesContent');
            modal.style.display = 'block';
            content.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
            try {
                const data = await apiCall(`/admin/messages/${conversationId}`);
                const messages = data.data || [];
                if (messages.length === 0) {
                    content.innerHTML = '<div class="no-data">No messages in this conversation</div>';
                    return;
                }
                content.innerHTML = `<div class="messages-container">${messages.map(msg => `<div class="message"><div class="message-header">${msg.senderName || 'Unknown'}<span class="message-time">${msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleString() : ''}</span></div><div class="message-text">${msg.text || ''}</div></div>`).join('')}</div>`;
            } catch (error) {
                content.innerHTML = `<div class="error">Failed to load messages: ${error.message}</div>`;
            }
        }
       
        function switchSubscriptionTab(tabName) {
            const parent = document.querySelector('.subscriptions-management');
            parent.querySelectorAll(':scope > .tab-content').forEach(c => c.classList.remove('active'));
            parent.querySelectorAll(':scope > .subscription-tabs > .tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="switchSubscriptionTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
       
        async function toggleSystemFeature(feature, enabled) {
            try {
                await apiCall(`/admin/system/toggle/${feature}`, { method: 'PATCH', body: JSON.stringify({ enabled }) });
                alert(`${feature.charAt(0).toUpperCase() + feature.slice(1)} module has been ${enabled ? 'enabled' : 'disabled'}.`);
            } catch (error) {
                alert(`Failed to toggle ${feature}: ${error.message}`);
                document.getElementById(`${feature}Toggle`).checked = !enabled;
            }
        }
       
        function createSubscriptionPlan() { document.getElementById('createPlanModal').style.display = 'block'; }
        function addFeature() { /* ... implementation ... */ }
        function removeFeature(button) { button.parentElement.remove(); }
        async function deleteSubscriptionPlan(planId) { /* ... implementation ... */ }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function refreshEstimations() { estimationsData = []; loadEstimationsData(); }
        function refreshMessages() { messagesData = []; loadMessagesData(); }
        function refreshAllData() { /* ... implementation ... */ }
        function exportData() { alert('Export functionality coming soon!'); }
        function systemHealth() { alert('All systems operational! ✅'); }
       
        function logout(confirmLogout = true) {
            const doLogout = () => {
                console.log('👋 Logging out admin...');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            };
            if (confirmLogout) {
                if (confirm('Are you sure you want to logout?')) doLogout();
            } else {
                doLogout();
            }
        }
       
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('statusForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                try {
                    await apiCall(`/admin/estimations/${currentEstimationId}/status`, { method: 'PATCH', body: JSON.stringify({ status: document.getElementById('statusSelect').value, notes: document.getElementById('statusNotes').value }) });
                    alert('Estimation status updated successfully!');
                    closeModal('statusModal');
                    refreshEstimations();
                } catch (error) {
                    alert('Failed to update status: ' + error.message);
                }
            });
            
            document.getElementById('uploadResultForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const fileInput = document.getElementById('resultFile');
                if (!fileInput.files[0]) return alert('Please select a file to upload.');
                const formData = new FormData();
                formData.append('resultFile', fileInput.files[0]);
                formData.append('amount', document.getElementById('estimationAmount').value);
                formData.append('notes', document.getElementById('resultNotes').value);
                try {
                    await apiCall(`/admin/estimations/${currentEstimationId}/result`, { method: 'POST', body: formData });
                    alert('Estimation result uploaded successfully!');
                    closeModal('uploadResultModal');
                    refreshEstimations();
                } catch (error) {
                    alert('Failed to upload result: ' + error.message);
                }
            });

            document.getElementById('createPlanForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                // Logic to create plan
            });
        });
       
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) modal.style.display = 'none';
            });
        }
       
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing admin dashboard...');
            if (!getToken()) {
                window.location.href = 'index.html';
                return;
            }
            loadDashboardStats();
            setInterval(refreshAllData, 5 * 60 * 1000);
        });
   </script>
</body>
</html>
