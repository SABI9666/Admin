<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .admin-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; color: white; }
        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.jobs { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.quotes { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.contractors { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-icon.designers { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-icon.estimations { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #333; }
        .stat-icon.messages { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: #333; }
        .stat-icon.subscriptions { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); }
        .stat-number { font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 14px; font-weight: 500; }
        .section { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { margin-bottom: 20px; color: #333; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .tabs { display: flex; margin-bottom: 30px; border-bottom: 2px solid #e9ecef; flex-wrap: nowrap; overflow-x: auto; }
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; border-bottom: 3px solid transparent; font-size: 16px; font-weight: 500; color: #666; transition: all 0.3s; white-space: nowrap; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #dee2e6; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table thead { background: #f8f9fa; }
        .data-table th { padding: 15px 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
        .data-table td { padding: 12px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        .data-table tbody tr:hover { background: #f8f9fa; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; color: white; text-transform: capitalize; }
        .status-badge.pending { background: #ffc107; color: #333; }
        .status-badge.in-progress { background: #17a2b8; }
        .status-badge.completed, .status-badge.active, .status-badge.approved, .status-badge.read, .status-badge.replied { background: #28a745; }
        .status-badge.rejected, .status-badge.inactive, .status-badge.expired { background: #dc3545; }
        .status-badge.cancelled, .status-badge.closed, .status-badge.incomplete { background: #6c757d; }
        .status-badge.open { background: #007bff; }
        .status-badge.unread { background: #ffc107; color: #333; }
        .status-badge.blocked { background: #343a40; }
        .type-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .type-badge.admin { background: #dc3545; color: white; }
        .type-badge.contractor { background: #28a745; color: white; }
        .type-badge.designer { background: #007bff; color: white; }
        .type-badge.user, .type-badge.general { background: #6c757d; color: white; }
        .type-badge.support { background: #ffc107; color: #333; }
        .type-badge.feedback { background: #17a2b8; color: white; }
        .loading { text-align: center; padding: 60px; color: #666; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #f5c6cb; text-align: center; }
        .no-data { text-align: center; padding: 40px; color: #666; font-style: italic; }
        .action-group { display: flex; gap: 5px; }
        .user-info, .contractor-info, .project-info { display: flex; flex-direction: column; }
        .user-info strong, .contractor-info strong, .project-info strong { font-weight: 600; }
        .user-info small, .contractor-info small, .project-info small { color: #666; font-size: 12px; }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .overview-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .overview-card h4 { margin-bottom: 15px; color: #333; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; border-radius: 12px; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .status-select { padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: white; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .upload-progress { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease; text-align: center; color: white; font-weight: bold; line-height: 20px; }
        .messages-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .messages-stats { display: flex; gap: 15px; }
        .stat-item { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .stat-item.unread { background: #fff3cd; color: #856404; }
        .stat-item.blocked { background: #f8d7da; color: #721c24; }
        .unread-message { background: #e9f5ff; }
        .unread-message td { font-weight: 600; }
        .blocked-message { background: #fff5f5; opacity: 0.7; text-decoration: line-through; }
        .detail-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb; }
        .detail-section:last-child { border-bottom: none; }
        .detail-section h4 { color: #333; margin-bottom: 10px; font-size: 16px; }
        .detail-section p { margin: 5px 0; color: #666; }
        .detail-section p strong { color: #333; margin-right: 5px;}
        .original-message { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #6c757d; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .header-actions { justify-content: center; flex-wrap: wrap; }
            .modal-content { width: 95%; }
            .messages-header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <div class="header-actions">
                <div id="authStatus" style="background: #dc3545; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">
                    <i class="fas fa-exclamation-triangle"></i> <span>No Auth</span>
                </div>
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i> <span id="adminName">Not Logged In</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading"><div class="spinner"></div><p>Loading dashboard statistics...</p></div>
        </div>

        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            <div class="tabs">
                <button class="tab active" onclick="showTab(event, 'overview')"><i class="fas fa-home"></i> Overview</button>
                <button class="tab" onclick="showTab(event, 'profile-reviews')"><i class="fas fa-user-check"></i> Profile Reviews</button>
                <button class="tab" onclick="showTab(event, 'users')"><i class="fas fa-users"></i> Users</button>
                <button class="tab" onclick="showTab(event, 'jobs')"><i class="fas fa-briefcase"></i> Jobs</button>
                <button class="tab" onclick="showTab(event, 'quotes')"><i class="fas fa-file-invoice-dollar"></i> Quotes</button>
                <button class="tab" onclick="showTab(event, 'estimations')"><i class="fas fa-calculator"></i> Estimations</button>
                <button class="tab" onclick="showTab(event, 'messages')"><i class="fas fa-comments"></i> Messages</button>
                <button class="tab" onclick="showTab(event, 'subscriptions')"><i class="fas fa-credit-card"></i> Subscriptions</button>
            </div>

            <div id="overview-tab" class="tab-content active"></div>
            <div id="profile-reviews-tab" class="tab-content"></div>
            <div id="users-tab" class="tab-content"></div>
            <div id="jobs-tab" class="tab-content"></div>
            <div id="quotes-tab" class="tab-content"></div>
            <div id="estimations-tab" class="tab-content"></div>
            <div id="messages-tab" class="tab-content"></div>
            <div id="subscriptions-tab" class="tab-content"></div>
        </div>
    </div>

    <div id="modal-container"></div>

    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 10001;"></div>

    <div id="global-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; align-items: center; justify-content: center; color: #333;">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p style="font-size: 18px;">Loading Admin Dashboard...</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & GLOBAL STATE ---
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        const appState = { currentUser: null };

        // --- CORE & HELPER FUNCTIONS ---
        const getToken = () => localStorage.getItem('jwtToken');

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
            const token = getToken();
            if (!token) {
                showNotification('Authentication token not found. Please log in.', 'error');
                logout();
                throw new Error('No auth token');
            }
            const headers = { 'Authorization': `Bearer ${token}` };
            if (!isFormData) {
                headers['Content-Type'] = 'application/json';
            }
            const options = { method, headers };
            if (body) {
                options.body = isFormData ? body : JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP error! Status: ${response.status}` }));
                    throw new Error(errorData.message || 'An unknown API error occurred.');
                }
                return response.status === 204 ? {} : await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showNotification(error.message, 'error');
                throw error;
            }
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
            notification.style.cssText = `
                padding: 12px 16px; margin-bottom: 10px; border-radius: 6px; color: white;
                background: ${colors[type]}; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                position: relative; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
            `;
            notification.innerHTML = `
                <i class="fas fa-${icons[type]}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer; font-size: 18px; line-height: 1;">&times;</button>
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), duration);
        }

        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);

        function createModal(title, bodyContent, footerContent = '') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-overlay" id="modalOverlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">${bodyContent}</div>
                        ${footerContent ? `<div class="modal-footer">${footerContent}</div>` : ''}
                    </div>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        
        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) modalOverlay.style.display = 'none';
        }

        // --- AUTHENTICATION & INITIALIZATION ---
        function checkAuth() {
            const token = getToken();
            const user = localStorage.getItem('currentUser');
            const loader = document.getElementById('global-loader');

            if (!token || !user) {
                loader.innerHTML = '<p>Redirecting to login...</p>';
                setTimeout(() => window.location.href = 'index.html', 1500); // Redirect if no auth
                return false;
            }
            try {
                const userData = JSON.parse(user);
                if (userData.type !== 'admin' && userData.role !== 'admin') {
                    showNotification('Access Denied. Admin privileges required.', 'error');
                    logout();
                    return false;
                }
                document.getElementById('authStatus').innerHTML = '<i class="fas fa-check-circle"></i> <span>Authenticated</span>';
                document.getElementById('authStatus').style.background = '#28a745';
                document.getElementById('adminName').textContent = userData.name || 'Admin';
                appState.currentUser = userData;
                return true;
            } catch (error) {
                showNotification('Invalid session data. Please log in again.', 'error');
                logout();
                return false;
            }
        }

        function logout() {
            localStorage.clear();
            showNotification('You have been logged out.', 'success');
            setTimeout(() => window.location.href = 'index.html', 1000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                loadStats();
                loadOverview(); // Load the default tab
                document.getElementById('global-loader').style.display = 'none';
            }
        });

        // --- TAB MANAGEMENT ---
        function showTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.currentTarget.classList.add('active');
            
            const loaderHtml = `<div class="loading"><div class="spinner"></div><p>Loading ${tabName}...</p></div>`;
            document.getElementById(`${tabName}-tab`).innerHTML = loaderHtml;

            const loadFunctions = {
                'overview': loadOverview,
                'users': loadUsers,
                'jobs': loadJobs,
                'quotes': loadQuotes,
                'estimations': loadEstimations,
                'messages': loadMessages,
                'subscriptions': loadSubscriptions,
                'profile-reviews': loadProfileReviews,
            };
            loadFunctions[tabName]();
        }

        // --- RENDER & LOAD FUNCTIONS ---
        const renderError = (container, message) => container.innerHTML = `<div class="error"><p>${message}</p></div>`;
        const renderNoData = (container, message) => container.innerHTML = `<div class="no-data"><p>${message}</p></div>`;

        async function loadStats() {
            const statsGrid = document.getElementById('statsGrid');
            try {
                const data = await apiCall('/admin/dashboard');
                const stats = data.stats || {};
                statsGrid.innerHTML = `
                    <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div>
                    <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div class="stat-number">${stats.totalContractors || 0}</div><div class="stat-label">Contractors</div></div>
                    <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div class="stat-number">${stats.totalDesigners || 0}</div><div class="stat-label">Designers</div></div>
                    <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div>
                    <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Quotes</div></div>
                    <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div>
                    <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-envelope"></i></div><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div>
                    <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-crown"></i></div><div class="stat-number">${stats.activeSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div>
                `;
            } catch (error) {
                statsGrid.innerHTML = `<div class="error" style="grid-column: 1 / -1;"><h3>Failed to load statistics</h3><p>${error.message}</p><button class="btn" onclick="loadStats()">Retry</button></div>`;
            }
        }

        async function loadOverview() {
            const container = document.getElementById('overview-tab');
            try {
                const data = await apiCall('/admin/dashboard');
                container.innerHTML = `
                    <h3>System Overview</h3>
                    <div class="overview-grid">
                        <div class="overview-card">
                            <h4>Recent Activity</h4>
                            <p>System is running smoothly. Welcome back, ${appState.currentUser.name || 'Admin'}!</p>
                        </div>
                        <div class="overview-card">
                            <h4>Quick Actions</h4>
                            <button class="btn" onclick="document.querySelector('.tab[onclick*=\\'users\\']').click()">Manage Users</button>
                            <button class="btn btn-secondary" onclick="document.querySelector('.tab[onclick*=\\'profile-reviews\\']').click()">Review Profiles</button>
                        </div>
                    </div>`;
            } catch (error) {
                renderError(container, 'Failed to load overview data.');
            }
        }

        async function loadUsers() {
            const container = document.getElementById('users-tab');
            try {
                const data = await apiCall('/admin/users');
                const users = data.data || [];
                if (users.length === 0) return renderNoData(container, 'No users found.');
                container.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${users.map(user => {
                                    const isActive = user.isActive !== false;
                                    return `<tr data-user-id="${user._id}">
                                        <td>${user.name || 'N/A'}</td>
                                        <td>${user.email || 'N/A'}</td>
                                        <td><span class="type-badge ${user.type || 'user'}">${user.type || 'user'}</span></td>
                                        <td><span class="status-badge ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                                        <td>${formatDate(user.createdAt)}</td>
                                        <td>
                                            <div class="action-group">
                                                <button class="btn btn-sm btn-warning" onclick="toggleUserStatus('${user._id}', ${isActive})" title="${isActive ? 'Deactivate' : 'Activate'}">
                                                    <i class="fas fa-toggle-${isActive ? 'on' : 'off'}"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            } catch (error) {
                renderError(container, 'Failed to load users data.');
            }
        }
        
        async function loadEstimations() {
            const container = document.getElementById('estimations-tab');
            try {
                const data = await apiCall('/admin/estimations');
                const estimations = data.data || [];
                if (estimations.length === 0) return renderNoData(container, 'No estimations found.');
                container.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Result</th><th>Date</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${estimations.map(est => `
                                    <tr data-estimation-id="${est._id}">
                                        <td><div class="project-info"><strong>${est.projectTitle || 'N/A'}</strong><small>${est.projectType || 'General'}</small></div></td>
                                        <td><div class="contractor-info"><strong>${est.contractorName || 'N/A'}</strong><small>${est.contractorEmail || 'N/A'}</small></div></td>
                                        <td>
                                            <select class="status-select" onchange="updateEstimationStatus('${est._id}', this.value)">
                                                <option value="pending" ${est.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="in-progress" ${est.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                                <option value="completed" ${est.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                <option value="cancelled" ${est.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                        </td>
                                        <td>
                                            ${est.uploadedFiles?.length > 0 ? `<button class="btn btn-sm btn-info" onclick="downloadEstimationFiles('${est._id}')"><i class="fas fa-download"></i> ${est.uploadedFiles.length} files</button>` : `<span style="font-style: italic; color: #888;">No files</span>`}
                                        </td>
                                        <td>
                                            ${est.resultFile ? `<button class="btn btn-sm btn-success" onclick="downloadEstimationResult('${est._id}')"><i class="fas fa-file-download"></i> Download</button>` : `<button class="btn btn-sm btn-warning" onclick="uploadEstimationResult('${est._id}')"><i class="fas fa-upload"></i> Upload</button>`}
                                        </td>
                                        <td>${formatDate(est.createdAt)}</td>
                                        <td><button class="btn btn-sm btn-danger" onclick="deleteEstimation('${est._id}')"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            } catch (error) {
                renderError(container, 'Failed to load estimations data.');
            }
        }

        async function loadMessages() {
            const container = document.getElementById('messages-tab');
            try {
                const data = await apiCall('/admin/messages');
                const messages = data.data || [];
                const unreadCount = messages.filter(m => !m.isRead).length;
                const blockedCount = messages.filter(m => m.isBlocked).length;

                container.innerHTML = `
                    <div class="messages-header">
                        <div class="messages-stats">
                            <span class="stat-item">Total: ${messages.length}</span>
                            ${unreadCount > 0 ? `<span class="stat-item unread">Unread: ${unreadCount}</span>` : ''}
                            ${blockedCount > 0 ? `<span class="stat-item blocked">Blocked: ${blockedCount}</span>` : ''}
                        </div>
                        <div class="messages-actions">
                             ${unreadCount > 0 ? `<button class="btn btn-success btn-sm" onclick="markAllAsRead()"><i class="fas fa-check-double"></i> Mark All Read</button>`: ''}
                            <button class="btn btn-info btn-sm" onclick="loadMessages()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        </div>
                    </div>
                    ${messages.length === 0 ? '<div class="no-data"><p>No messages found.</p></div>' : `
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>From</th><th>Subject</th><th>Type</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${messages.map(msg => {
                                    const isUnread = !msg.isRead;
                                    const isBlocked = msg.isBlocked;
                                    return `<tr class="${isUnread ? 'unread-message' : ''} ${isBlocked ? 'blocked-message' : ''}" data-message-id="${msg._id}">
                                        <td><div class="user-info"><strong>${msg.senderName || 'Anonymous'}</strong><small>${msg.senderEmail || 'N/A'}</small></div></td>
                                        <td>${msg.subject || 'No Subject'}</td>
                                        <td><span class="type-badge ${msg.type || 'general'}">${msg.type || 'general'}</span></td>
                                        <td><span class="status-badge ${isBlocked ? 'blocked' : (msg.isReplied ? 'replied' : (isUnread ? 'unread' : 'read'))}">${isBlocked ? 'Blocked' : (msg.isReplied ? 'Replied' : (isUnread ? 'Unread' : 'Read'))}</span></td>
                                        <td>${formatDate(msg.createdAt)}</td>
                                        <td>
                                            <div class="action-group">
                                                <button class="btn btn-sm btn-info" onclick="viewMessage('${msg._id}')" title="View"><i class="fas fa-eye"></i></button>
                                                <button class="btn btn-sm" onclick="replyToMessage('${msg._id}')" title="Reply"><i class="fas fa-reply"></i></button>
                                                <button class="btn btn-sm ${isBlocked ? 'btn-success' : 'btn-warning'}" onclick="toggleBlockMessage('${msg._id}', ${isBlocked})" title="${isBlocked ? 'Unblock' : 'Block'}"><i class="fas fa-${isBlocked ? 'check-circle' : 'ban'}"></i></button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteMessage('${msg._id}')" title="Delete"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`}
                `;
            } catch (error) {
                renderError(container, 'Failed to load messages.');
            }
        }
        
        async function loadProfileReviews() {
            const container = document.getElementById('profile-reviews-tab');
            try {
                const data = await apiCall('/admin/profile-reviews');
                const reviews = data.data || [];
                if (reviews.length === 0) return renderNoData(container, 'No pending profile reviews.');
                 container.innerHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>User</th><th>Type</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead>
                            <tbody>
                                ${reviews.map(review => `
                                    <tr data-review-id="${review._id}">
                                        <td>${review.user?.name || 'N/A'}</td>
                                        <td><span class="type-badge ${review.user?.type || 'user'}">${review.user?.type || 'user'}</span></td>
                                        <td><span class="status-badge ${review.status}">${review.status}</span></td>
                                        <td>${formatDate(review.createdAt)}</td>
                                        <td>
                                            <div class="action-group">
                                                <button class="btn btn-sm btn-info" onclick="viewProfileReview('${review._id}')"><i class="fas fa-eye"></i> View</button>
                                                ${review.status === 'pending' ? `
                                                <button class="btn btn-sm btn-success" onclick="approveProfile('${review._id}')"><i class="fas fa-check"></i> Approve</button>
                                                <button class="btn btn-sm btn-danger" onclick="rejectProfile('${review._id}')"><i class="fas fa-times"></i> Reject</button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
            } catch (error) {
                renderError(container, 'Failed to load profile reviews.');
            }
        }

        // --- DUMMY LOADERS for other tabs ---
        const loadJobs = () => renderNoData(document.getElementById('jobs-tab'), 'Jobs data will be loaded here.');
        const loadQuotes = () => renderNoData(document.getElementById('quotes-tab'), 'Quotes data will be loaded here.');
        const loadSubscriptions = () => renderNoData(document.getElementById('subscriptions-tab'), 'Subscriptions data will be loaded here.');


        // --- ACTION FUNCTIONS ---

        // User Actions
        async function toggleUserStatus(userId, isActive) {
            const action = isActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;
            try {
                await apiCall(`/admin/users/${userId}/toggle-status`, 'POST');
                showNotification(`User has been ${action}d successfully.`, 'success');
                loadUsers();
            } catch (error) {
                showNotification(`Failed to ${action} user.`, 'error');
            }
        }

        // Estimation Actions
        async function updateEstimationStatus(id, status) {
            try {
                await apiCall(`/admin/estimations/${id}/status`, 'PUT', { status });
                showNotification('Estimation status updated successfully.', 'success');
            } catch (error) {
                showNotification('Failed to update status.', 'error');
                loadEstimations(); // Revert on fail
            }
        }

        function uploadEstimationResult(id) {
            const bodyContent = `
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="resultFile">Select Result File</label>
                        <input type="file" id="resultFile" name="resultFile" required>
                    </div>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                    </div>
                </form>`;
            const footerContent = `
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" onclick="handleUpload('${id}')">Upload File</button>`;
            createModal('Upload Estimation Result', bodyContent, footerContent);
        }

        function handleUpload(id) {
            const form = document.getElementById('uploadForm');
            const fileInput = document.getElementById('resultFile');
            const file = fileInput.files[0];
            if (!file) {
                showNotification('Please select a file to upload.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('resultFile', file);
            
            const xhr = new XMLHttpRequest();
            const token = getToken();

            xhr.open('POST', `${API_BASE}/admin/estimations/${id}/upload-result`, true);
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            
            document.getElementById('uploadProgress').style.display = 'block';
            const progressFill = document.getElementById('progressFill');

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressFill.style.width = percentComplete + '%';
                    progressFill.textContent = percentComplete + '%';
                }
            };

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    showNotification('Result file uploaded successfully!', 'success');
                    closeModal();
                    loadEstimations();
                } else {
                    const errorResponse = JSON.parse(xhr.responseText);
                    showNotification(errorResponse.message || 'Upload failed.', 'error');
                    progressFill.style.background = '#dc3545';
                }
            };
            
            xhr.onerror = () => {
                showNotification('An error occurred during the upload.', 'error');
                progressFill.style.background = '#dc3545';
            };

            xhr.send(formData);
        }
        
        async function deleteEstimation(id) {
            if (!confirm('Are you sure you want to permanently delete this estimation?')) return;
            try {
                await apiCall(`/admin/estimations/${id}`, 'DELETE');
                showNotification('Estimation deleted successfully.', 'success');
                loadEstimations();
            } catch (error) {
                showNotification('Failed to delete estimation.', 'error');
            }
        }
        
        // Message Actions
        async function viewMessage(id) {
            try {
                const data = await apiCall(`/admin/messages/${id}`);
                const msg = data.data;
                const body = `
                    <div class="detail-section">
                        <h4>Sender Information</h4>
                        <p><strong>Name:</strong> ${msg.senderName}</p>
                        <p><strong>Email:</strong> ${msg.senderEmail}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Message Details</h4>
                        <p><strong>Subject:</strong> ${msg.subject}</p>
                        <p><strong>Received:</strong> ${formatDate(msg.createdAt)}</p>
                    </div>
                     <div class="detail-section">
                        <h4>Content</h4>
                        <p style="white-space: pre-wrap; background: #f4f4f4; padding: 10px; border-radius: 4px;">${msg.message}</p>
                    </div>
                `;
                createModal('Message Details', body, `<button class="btn" onclick="closeModal()">Close</button>`);
                loadMessages(); // Refresh list to mark as read
            } catch(e) { /* error handled in apiCall */ }
        }

        function replyToMessage(id) {
            const body = `
                <div class="original-message">This will be a reply to message ID: ${id}</div>
                <div class="form-group">
                    <label for="replyContent">Your Reply:</label>
                    <textarea id="replyContent" rows="5" placeholder="Type your response here..."></textarea>
                </div>`;
            const footer = `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn" onclick="sendReply('${id}')">Send Reply</button>`;
            createModal('Reply to Message', body, footer);
        }

        async function sendReply(id) {
            const content = document.getElementById('replyContent').value;
            if (!content) return showNotification('Reply cannot be empty.', 'warning');
            try {
                await apiCall(`/admin/messages/${id}/reply`, 'POST', { reply: content });
                showNotification('Reply sent successfully!', 'success');
                closeModal();
                loadMessages();
            } catch(e) { /* error handled */ }
        }

        async function toggleBlockMessage(id, isBlocked) {
            const action = isBlocked ? 'unblock' : 'block';
             if (!confirm(`Are you sure you want to ${action} this message sender?`)) return;
            try {
                await apiCall(`/admin/messages/${id}/block`, 'POST', { block: !isBlocked });
                showNotification(`Sender ${action}ed successfully.`, 'success');
                loadMessages();
            } catch(e) { /* error handled */ }
        }

        async function deleteMessage(id) {
            if (!confirm('Are you sure you want to delete this message? This cannot be undone.')) return;
             try {
                await apiCall(`/admin/messages/${id}`, 'DELETE');
                showNotification('Message deleted.', 'success');
                loadMessages();
            } catch(e) { /* error handled */ }
        }

        async function markAllAsRead() {
             if (!confirm('Mark all messages as read?')) return;
             try {
                await apiCall('/admin/messages/mark-all-read', 'POST');
                showNotification('All messages marked as read.', 'success');
                loadMessages();
            } catch(e) { /* error handled */ }
        }

        // Profile Review Actions
        async function viewProfileReview(id) {
            try {
                const data = await apiCall(`/admin/profile-reviews/${id}`);
                const review = data.data;
                let detailsHtml = '';
                for (const [key, value] of Object.entries(review.profileData)) {
                    detailsHtml += `<p><strong>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</strong> ${value || 'N/A'}</p>`;
                }
                const body = `
                    <div class="detail-section">
                        <h4>User: ${review.user.name} (${review.user.email})</h4>
                    </div>
                    <div class="detail-section">
                        <h4>Submitted Profile Data</h4>
                        ${detailsHtml}
                    </div>`;
                createModal('Profile Review Details', body, `<button class="btn" onclick="closeModal()">Close</button>`);
            } catch (e) { /* error handled */ }
        }

        async function approveProfile(id) {
            if (!confirm('Are you sure you want to approve this profile?')) return;
            try {
                await apiCall(`/admin/profile-reviews/${id}/approve`, 'POST');
                showNotification('Profile approved successfully!', 'success');
                loadProfileReviews();
            } catch (e) { /* error handled */ }
        }

        function rejectProfile(id) {
            const body = `
                <div class="form-group">
                    <label for="rejectionReason">Reason for Rejection (Optional)</label>
                    <textarea id="rejectionReason" placeholder="Provide a reason for the user..."></textarea>
                </div>`;
            const footer = `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-danger" onclick="submitRejection('${id}')">Confirm Rejection</button>`;
            createModal('Reject Profile', body, footer);
        }
        
        async function submitRejection(id) {
            const reason = document.getElementById('rejectionReason').value;
            try {
                await apiCall(`/admin/profile-reviews/${id}/reject`, 'POST', { reason });
                showNotification('Profile rejected.', 'success');
                closeModal();
                loadProfileReviews();
            } catch (e) { /* error handled */ }
        }

    </script>
</body>
</html>
