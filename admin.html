<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Ultra Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div id="notification-container"></div>

    <div class="animated-bg"></div>
    <div class="floating-orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
        <div class="orb orb3"></div>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">STEELCONNECT</div>
                <div class="logo-subtitle">Admin Portal</div>
            </div>
            <nav class="nav-menu">
                <button class="tab active" onclick="showTab('overview')"><i class="fas fa-home"></i> Overview</button>
                <button class="tab" onclick="showTab('users')"><i class="fas fa-users"></i> Users</button>
                <button class="tab" onclick="showTab('jobs')"><i class="fas fa-briefcase"></i> Jobs</button>
                <button class="tab" onclick="showTab('quotes')"><i class="fas fa-file-invoice-dollar"></i> Quotes</button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                    <span class="notification-badge" id="estimationBadge" style="display:none;">0</span>
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                    <span class="notification-badge" id="messageBadge" style="display:none;">0</span>
                </button>
                <button class="tab" onclick="showTab('subscriptions')"><i class="fas fa-credit-card"></i> Subscriptions</button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <div class="header-actions">
                    <div class="admin-badge">
                        <i class="fas fa-user-shield"></i>
                        <span id="adminName">Admin</span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <div class="stats-grid" id="statsGrid">
                <div class="loading"><div class="spinner"></div><p>Loading dashboard statistics...</p></div>
            </div>

            <section class="section">
                <h2 id="section-title"><i class="fas fa-chart-bar"></i> Management Portal</h2>
                
                <div id="overview-tab" class="tab-content active"></div>
                <div id="users-tab" class="tab-content"></div>
                <div id="jobs-tab" class="tab-content"></div>
                <div id="quotes-tab" class="tab-content"></div>
                <div id="estimations-tab" class="tab-content"></div>
                <div id="messages-tab" class="tab-content"></div>
                <div id="subscriptions-tab" class="tab-content"></div>
            </section>
        </main>
    </div>

    <div class="fab" onclick="refreshAllData()" title="Refresh Data">
        <i class="fas fa-sync-alt"></i>
    </div>

    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>View Estimation Files</h3>
                <button class="close" onclick="closeModal('pdfModal')">&times;</button>
            </div>
            <div class="pdf-viewer-container">
                <div class="pdf-viewer-header">
                    <h4 id="pdfFileName">Document</h4>
                    <div class="pdf-viewer-controls">
                        <button class="btn btn-sm" onclick="previousPDF()"><i class="fas fa-arrow-left"></i> Previous</button>
                        <span id="pdfPageInfo">1 / 1</span>
                        <button class="btn btn-sm" onclick="nextPDF()">Next <i class="fas fa-arrow-right"></i></button>
                        <button class="btn btn-info btn-sm" onclick="downloadCurrentPDF()"><i class="fas fa-download"></i> Download</button>
                    </div>
                </div>
                <iframe id="pdfViewer" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Conversation Messages</h3>
                <button class="close" onclick="closeModal('messagesModal')">&times;</button>
            </div>
            <div id="messagesContent"></div>
            <div class="message-reply-box" id="replyBox" style="display:none;">
                <textarea class="message-input" id="replyMessage" placeholder="Type your message here..."></textarea>
                <button class="btn btn-success" onclick="sendReply()"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </div>
        </div>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Status</h3>
                <button class="close" onclick="closeModal('statusModal')">&times;</button>
            </div>
            <form id="statusForm">
                <input type="hidden" id="statusItemId" />
                <input type="hidden" id="statusItemType" />
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" required></select>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (Optional):</label>
                    <textarea id="statusNotes" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!getToken()) {
             localStorage.setItem('adminToken', 'your_dummy_admin_token_for_testing');
        }
        
        initializeApp();

        document.getElementById('statusForm').addEventListener('submit', handleStatusUpdate);
    });

    const API_BASE = 'https://steelconnect-backend.onrender.com/api';
    let dashboardData = {};
    let currentTab = 'overview';
    let currentPDFIndex = 0;
    let currentPDFs = [];
    let currentConversationId = null;

    function getLoadingHtml() {
        return '<div class="loading"><div class="spinner"></div><p>Loading data...</p></div>';
    }
    function getErrorHtml(message) {
        return `<div class="error">Failed to load data: ${message}</div>`;
    }
    function getNoDataHtml(message) {
        return `<div class="no-data">${message}</div>`;
    }

    // NEW FUNCTION: For user feedback instead of alert()
    function showAlert(message, type = 'info', duration = 4000) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        notification.innerHTML = `
            <i class="fas ${icons[type]}"></i>
            <span>${message}</span>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, duration);
    }

    function getToken() {
        return localStorage.getItem('adminToken');
    }

    function logout() {
        localStorage.removeItem('adminToken');
        showAlert('You have been logged out.', 'info');
        // In a real app, you would redirect to a login page.
        // window.location.href = 'admin-login.html'; 
    }

    async function apiCall(endpoint, options = {}) {
        const token = getToken();
        if (!token) {
            console.error("Authentication token not found.");
            showAlert('Authentication failed. Please log in again.', 'error');
            return;
        }

        const config = {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            ...options
        };

        try {
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            if (response.status === 401) {
                logout();
                return;
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }
            if (response.status === 204) {
                 return { success: true }; // Return a success indicator for DELETE
            }
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            showAlert(error.message, 'error');
            throw error;
        }
    }

    function initializeApp() {
        loadDashboardStats();
        showTab('overview');
    }
    
    function refreshAllData() {
        showAlert('Refreshing all data...', 'info');
        loadDashboardStats();
        loadTabData(currentTab);
    }

    async function loadDashboardStats() {
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = getLoadingHtml();
        try {
            const data = await apiCall('/admin/dashboard');
            dashboardData = data.data;
            document.getElementById('adminName').textContent = dashboardData.adminUser ? dashboardData.adminUser.split('@')[0] : 'Admin';
            renderStatsGrid(dashboardData.stats);
            updateNotificationBadges();
        } catch (error) {
            statsGrid.innerHTML = getErrorHtml(error.message);
        }
    }

    function renderStatsGrid(stats) {
        if (!stats) return;
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
            <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div class="stat-number">${stats.contractors || 0}</div><div class="stat-label">Contractors</div></div>
            <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div class="stat-number">${stats.designers || 0}</div><div class="stat-label">Designers</div></div>
            <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div>
            <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div>
            <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div>
            <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div><div class="stat-number">${stats.totalSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div>
            <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-comments"></i></div><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div>
        `;
    }

    function updateNotificationBadges() {
        const estimationBadge = document.getElementById('estimationBadge');
        const messageBadge = document.getElementById('messageBadge');
        
        if (dashboardData.stats?.pendingEstimations > 0) {
            estimationBadge.textContent = dashboardData.stats.pendingEstimations;
            estimationBadge.style.display = 'block';
        } else {
            estimationBadge.style.display = 'none';
        }

        if (dashboardData.stats?.unreadMessages > 0) {
            messageBadge.textContent = dashboardData.stats.unreadMessages;
            messageBadge.style.display = 'block';
        } else {
            messageBadge.style.display = 'none';
        }
    }
    
    function showTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        const activeTab = document.getElementById(`${tabName}-tab`);
        activeTab.classList.add('active');
        activeTab.innerHTML = getLoadingHtml();

        const sectionTitle = document.getElementById('section-title');
        const titleText = tabName.charAt(0).toUpperCase() + tabName.slice(1);
        const iconClass = document.querySelector(`.tab.active i`).className;
        sectionTitle.innerHTML = `<i class="${iconClass}"></i> ${titleText} Management`;

        loadTabData(tabName);
    }
    
    function loadTabData(tabName) {
        switch(tabName) {
            case 'overview': renderOverviewTab(); break;
            case 'users': loadUsersData(); break;
            case 'jobs': loadJobsData(); break;
            case 'quotes': loadQuotesData(); break;
            case 'estimations': loadEstimationsData(); break;
            case 'messages': loadMessagesData(); break;
            case 'subscriptions': loadSubscriptionsData(); break;
        }
    }

    function renderOverviewTab() {
        const container = document.getElementById('overview-tab');
        if (!dashboardData || !dashboardData.stats) {
            container.innerHTML = getNoDataHtml('Overview data is not available yet. Please refresh.');
            return;
        }
        container.innerHTML = `
            <div class="success">
                <h3><i class="fas fa-check-circle"></i> System Status: All Systems Operational</h3>
                <p>Your SteelConnect admin panel is running smoothly.</p>
            </div>
            <div class="quick-stats-container">
                <h3><i class="fas fa-chart-line"></i> Quick Stats</h3>
                <div class="quick-stats-grid">
                    <div class="quick-stat"><strong style="color: #6366f1;">Active Jobs:</strong> <span>${dashboardData.stats.activeJobs || 0}</span></div>
                    <div class="quick-stat"><strong style="color: #22c55e;">Completed Jobs:</strong> <span>${dashboardData.stats.completedJobs || 0}</span></div>
                    <div class="quick-stat"><strong style="color: #f59e0b;">Pending Estimations:</strong> <span>${dashboardData.stats.pendingEstimations || 0}</span></div>
                    <div class="quick-stat"><strong style="color: #ec4899;">Active Subscriptions:</strong> <span>${dashboardData.stats.activeSubscriptions || 0}</span></div>
                </div>
            </div>
        `;
    }

    async function loadUsersData() {
        const container = document.getElementById('users-tab');
        try {
            const data = await apiCall('/admin/users');
            const users = data.data || [];
            if (users.length === 0) {
                container.innerHTML = getNoDataHtml('No users found.'); return;
            }
            container.innerHTML = `
                <h3><i class="fas fa-users"></i> All Users (${users.length})</h3>
                <table>
                    <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Joined</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.name}</strong></td>
                                <td>${user.email}</td>
                                <td><span class="user-type ${user.type}">${user.type}</span></td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td><div class="actions"><button class="btn btn-sm btn-danger" onclick="showAlert('Delete user feature not implemented.', 'error')"><i class="fas fa-trash"></i></button></div></td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        } catch (error) { container.innerHTML = getErrorHtml(error.message); }
    }

    async function loadJobsData() {
        const container = document.getElementById('jobs-tab');
        try {
            const data = await apiCall('/jobs');
            const jobs = data.data || [];
            if (jobs.length === 0) {
                container.innerHTML = getNoDataHtml('No jobs found.'); return;
            }
            container.innerHTML = `
                 <h3><i class="fas fa-briefcase"></i> All Jobs (${jobs.length})</h3>
                <table>
                    <thead><tr><th>Title</th><th>Poster</th><th>Budget</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${jobs.map(job => `
                            <tr>
                                <td><strong>${job.title}</strong></td>
                                <td>${job.posterName || 'N/A'}</td>
                                <td>${job.budget}</td>
                                <td><span class="status-badge ${job.status}">${job.status}</span></td>
                                <td>${new Date(job.createdAt).toLocaleDateString()}</td>
                                <td><div class="actions"><button class="btn btn-sm btn-danger" onclick="showAlert('Delete job feature not implemented.', 'error')"><i class="fas fa-trash"></i></button></div></td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        } catch (error) { container.innerHTML = getErrorHtml(error.message); }
    }

    async function loadQuotesData() {
        const container = document.getElementById('quotes-tab');
         try {
            const data = await apiCall('/quotes');
            const quotes = data.data || [];
            if (quotes.length === 0) {
                container.innerHTML = getNoDataHtml('No quotes found.'); return;
            }
            container.innerHTML = `
                <h3><i class="fas fa-file-invoice-dollar"></i> All Quotes (${quotes.length})</h3>
                <table>
                    <thead><tr><th>Job Title</th><th>Designer</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${quotes.map(quote => `
                            <tr>
                                <td><strong>${quote.jobTitle || 'N/A'}</strong></td>
                                <td>${quote.designerName || 'N/A'}</td>
                                <td>$${quote.quoteAmount}</td>
                                <td><span class="status-badge ${quote.status}">${quote.status}</span></td>
                                <td>${new Date(quote.createdAt).toLocaleDateString()}</td>
                                 <td><div class="actions"><button class="btn btn-sm btn-danger" onclick="showAlert('Delete quote feature not implemented.', 'error')"><i class="fas fa-trash"></i></button></div></td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        } catch (error) { container.innerHTML = getErrorHtml(error.message); }
    }
    
    async function loadEstimationsData() {
        const container = document.getElementById('estimations-tab');
        try {
            const data = await apiCall('/estimation');
            const estimations = data.estimations || [];
            if (estimations.length === 0) {
                container.innerHTML = getNoDataHtml('No estimations found.'); return;
            }
            container.innerHTML = `
                <h3><i class="fas fa-calculator"></i> All Estimations (${estimations.length})</h3>
                <table>
                    <thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Amount</th><th>Date</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${estimations.map(est => `
                            <tr>
                                <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                                <td>${est.contractorName || 'Unknown'}</td>
                                <td><span class="status-badge ${est.status}">${est.status}</span></td>
                                <td>${est.uploadedFiles?.length || 0}</td>
                                <td>${est.estimatedAmount ? `$${est.estimatedAmount}` : 'Pending'}</td>
                                <td>${new Date(est.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-sm" onclick="viewEstimationPDF('${est._id}')" title="View PDF Files"><i class="fas fa-file-pdf"></i></button>
                                        <button class="btn btn-sm btn-success" onclick="downloadAllEstimationFiles('${est._id}')" title="Download All Files"><i class="fas fa-download"></i></button>
                                        <button class="btn btn-sm btn-warning" onclick="openStatusModal('estimation', '${est._id}', '${est.status}')" title="Update Status"><i class="fas fa-edit"></i></button>
                                    </div>
                                </td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        } catch (error) { container.innerHTML = getErrorHtml(error.message); }
    }
    
    async function loadMessagesData() {
        const container = document.getElementById('messages-tab');
        try {
            const response = await apiCall('/messages');
            const conversations = response.data || [];
            if (conversations.length === 0) {
                container.innerHTML = getNoDataHtml('No conversations found.'); return;
            }
            container.innerHTML = `
                <h3><i class="fas fa-comments"></i> Conversations (${conversations.length})</h3>
                <div class="conversation-list">
                    ${conversations.map(conv => `
                        <div class="conversation-item" onclick="viewConversation('${conv.id}')">
                            <div class="conversation-header">
                                <div class="conversation-title">${conv.jobTitle || 'Unknown Job'}</div>
                                <div class="conversation-actions">
                                    <span class="conversation-time">${new Date(conv.updatedAt.seconds * 1000).toLocaleDateString()}</span>
                                    <button class="btn btn-sm btn-danger" onclick="deleteConversation(event, '${conv.id}')" title="Delete Conversation"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <p class="conversation-preview"><strong>Participants:</strong> ${conv.participants?.map(p => p.name).join(', ') || 'N/A'}</p>
                            <p class="conversation-preview"><strong>Last:</strong> ${conv.lastMessage || 'No messages'}</p>
                        </div>`).join('')}
                </div>`;
        } catch (error) { container.innerHTML = getErrorHtml(error.message); }
    }

    async function loadSubscriptionsData() {
        const container = document.getElementById('subscriptions-tab');
        container.innerHTML = getNoDataHtml('Subscriptions module is not yet implemented.');
    }
    
    // NEW FUNCTION: To download all files for an estimation
    async function downloadAllEstimationFiles(estimationId) {
        showAlert('Preparing files for download...', 'info');
        try {
            const data = await apiCall(`/estimation/${estimationId}`);
            const files = data.uploadedFiles || [];
            if (files.length === 0) {
                showAlert('No files found for this estimation.', 'error');
                return;
            }

            for (const file of files) {
                const link = document.createElement('a');
                link.href = file.url;
                link.download = file.name || 'download';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                // Wait a moment between downloads to prevent browser blocking
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        } catch (error) {
            showAlert('Failed to download files.', 'error');
        }
    }

    // NEW FUNCTION: To delete a conversation
    async function deleteConversation(event, conversationId) {
        event.stopPropagation(); // Prevents the modal from opening
        if (confirm('Are you sure you want to permanently delete this conversation?')) {
            try {
                await apiCall(`/messages/${conversationId}`, { method: 'DELETE' });
                showAlert('Conversation deleted successfully.', 'success');
                loadMessagesData(); // Refresh the conversation list
            } catch (error) {
                // The apiCall function already shows an error alert
            }
        }
    }

    async function viewEstimationPDF(estimationId) {
        try {
            const data = await apiCall(`/estimation/${estimationId}`);
            const files = data.uploadedFiles || [];
            currentPDFs = files.filter(file => file.url && file.url.toLowerCase().endsWith('.pdf'));
            if (currentPDFs.length === 0) {
                showAlert('No PDF files found for this estimation. Use the download button to get all files.', 'info');
                return;
            }
            currentPDFIndex = 0;
            displayPDF();
            openModal('pdfModal');
        } catch (error) {
            // Error is handled by apiCall
        }
    }

    function displayPDF() {
        if (currentPDFs.length === 0) return;
        const pdf = currentPDFs[currentPDFIndex];
        document.getElementById('pdfViewer').src = pdf.url;
        document.getElementById('pdfFileName').textContent = pdf.name || 'Document';
        document.getElementById('pdfPageInfo').textContent = `${currentPDFIndex + 1} / ${currentPDFs.length}`;
    }

    function previousPDF() {
        if (currentPDFIndex > 0) {
            currentPDFIndex--;
            displayPDF();
        }
    }
    function nextPDF() {
        if (currentPDFIndex < currentPDFs.length - 1) {
            currentPDFIndex++;
            displayPDF();
        }
    }
    function downloadCurrentPDF() {
        if (currentPDFs.length === 0) return;
        window.open(currentPDFs[currentPDFIndex].url, '_blank');
    }

    async function viewConversation(conversationId) {
        currentConversationId = conversationId;
        openModal('messagesModal');
        const messagesContent = document.getElementById('messagesContent');
        messagesContent.innerHTML = getLoadingHtml();
        try {
            const data = await apiCall(`/messages/${conversationId}/messages`);
            const messages = data.data || [];
            if (messages.length === 0) {
                messagesContent.innerHTML = getNoDataHtml('No messages in this conversation.');
                document.getElementById('replyBox').style.display = 'block';
                return;
            }
            messagesContent.innerHTML = `<div class="messages-container">${messages.map(msg => `<div class="message"><div class="message-header">${msg.senderName || 'Unknown'}<span class="message-time">${new Date(msg.createdAt.seconds * 1000).toLocaleString()}</span></div><div class="message-text">${msg.text || ''}</div></div>`).join('')}</div>`;
            document.getElementById('replyBox').style.display = 'block';
            const container = messagesContent.querySelector('.messages-container');
            container.scrollTop = container.scrollHeight;
        } catch (error) { messagesContent.innerHTML = getErrorHtml(error.message); }
    }

    async function sendReply() {
        const input = document.getElementById('replyMessage');
        const text = input.value.trim();
        if (!text) return;
        try {
            await apiCall(`/messages/${currentConversationId}/send`, { method: 'POST', body: JSON.stringify({ text }) });
            input.value = '';
            viewConversation(currentConversationId);
        } catch (error) { /* Error handled by apiCall */ }
    }
    
    function openStatusModal(itemType, itemId, currentStatus) {
        document.getElementById('statusItemId').value = itemId;
        document.getElementById('statusItemType').value = itemType;
        const statusSelect = document.getElementById('statusSelect');
        let options = '';
        if (itemType === 'estimation') {
            options = ['pending', 'in-progress', 'completed', 'rejected'].map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('');
        }
        statusSelect.innerHTML = options;
        openModal('statusModal');
    }

    async function handleStatusUpdate(event) {
        event.preventDefault();
        const id = document.getElementById('statusItemId').value;
        const type = document.getElementById('statusItemType').value;
        const status = document.getElementById('statusSelect').value;
        const notes = document.getElementById('statusNotes').value;
        const endpoint = `/estimation/${id}/status`;
        try {
            await apiCall(endpoint, { method: 'PUT', body: JSON.stringify({ status, notes }) });
            showAlert('Status updated successfully!', 'success');
            closeModal('statusModal');
            loadTabData(currentTab);
            loadDashboardStats();
        } catch (error) { /* Error handled by apiCall */ }
    }
    
    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    </script>
</body>
</html>
