<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            <div class="header-actions">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Admin</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            </div>

        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="tab" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab" onclick="showTab('jobs')">
                    <i class="fas fa-briefcase"></i> Jobs
                </button>
                <button class="tab" onclick="showTab('quotes')">
                    <i class="fas fa-file-invoice-dollar"></i> Quotes
                </button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                </button>
                <button class="tab" onclick="showTab('subscriptions')">
                    <i class="fas fa-credit-card"></i> Subscriptions
                </button>
            </div>
            
            <div id="overview-tab" class="tab-content active"></div>
            <div id="users-tab" class="tab-content"></div>
            <div id="jobs-tab" class="tab-content"></div>
            <div id="quotes-tab" class="tab-content"></div>
            <div id="estimations-tab" class="tab-content"></div>
            <div id="messages-tab" class="tab-content"></div>
            <div id="subscriptions-tab" class="tab-content"></div>
        </div>
    </div>

    <div id="statusModal" class="modal"> </div>
    <div id="uploadResultModal" class="modal"> </div>
    <div id="createPlanModal" class="modal"> </div>
    <div id="messagesModal" class="modal"> </div>
    <div id="filesModal" class="modal"> </div>

    <script>
        console.log('üèóÔ∏è SteelConnect Admin Dashboard loaded');

        // --- GLOBAL STATE & CONFIG ---
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let usersData = [];
        let jobsData = [];
        let quotesData = [];
        let estimationsData = [];
        let messagesData = [];
        let subscriptionsData = [];
        let subscriptionPlans = [];
        let currentEstimationId = null;

        // --- UI UTILITIES ---
        const loadingSpinner = `<div class="loading"><div class="spinner"></div><p>Loading...</p></div>`;
        const loadingError = (message) => `<div class="error"><strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${message}</div>`;
        
        function setContent(elementId, content) {
            const element = document.getElementById(elementId);
            if (element) element.innerHTML = content;
        }

        // --- CORE API & AUTH FUNCTIONS ---
        function getToken() {
            return localStorage.getItem('adminToken') || localStorage.getItem('token') || sessionStorage.getItem('token');
        }
        
        function logout(confirmLogout = true) {
            const doLogout = () => {
                console.log('üëã Logging out admin...');
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            };
            if (confirmLogout) {
                if (confirm('Are you sure you want to logout?')) doLogout();
            } else {
                doLogout();
            }
        }
        
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            if (!token) throw new Error('Authentication token not found.');
            
            const config = { headers: { 'Authorization': `Bearer ${token}` }, ...options };

            // **FIX:** Only add Content-Type header if there's a body to send.
            // This prevents sending it on GET requests, which can cause issues with some servers.
            if (options.body && !(options.body instanceof FormData)) {
                config.headers['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                console.error(`Unauthorized (401) access for endpoint: ${endpoint}`);
                throw new Error('Unauthorized access. Your session may have expired.');
            }
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `Server returned an error: ${response.statusText}` }));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            const textResponse = await response.text();
            return textResponse ? JSON.parse(textResponse) : {};
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);

        async function initializeDashboard() {
            console.log('üöÄ Initializing admin dashboard...');
            setContent('statsGrid', loadingSpinner);
            setContent('overview-tab', loadingSpinner);

            if (!getToken()) {
                console.log('‚ùå No token found, redirecting to login...');
                window.location.href = 'index.html';
                return;
            }

            try {
                const data = await apiCall('/admin/dashboard');

                if (!data || !data.data) throw new Error("Received an invalid response from the server.");
                dashboardData = data.data;

                if (!dashboardData.stats) throw new Error("Dashboard statistics are missing in the server response.");
                
                const adminName = document.getElementById('adminName');
                if (adminName && dashboardData.adminUser) adminName.textContent = dashboardData.adminUser.split('@')[0];

                renderStatsGrid(dashboardData.stats);
                renderOverviewTab();
                console.log('‚úÖ Dashboard initialized successfully.');

            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
                const errorMessage = loadingError(`Could not load dashboard. ${error.message}`);
                setContent('statsGrid', errorMessage);
                setContent('overview-tab', errorMessage);
            }
        }

        // --- TAB & CONTENT RENDERING ---
        function renderStatsGrid(stats) {
            const statsHtml = `
                <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div></div>
                <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div><div class="stat-number">${stats.contractors || 0}</div><div class="stat-label">Contractors</div></div></div>
                <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div><div class="stat-number">${stats.designers || 0}</div><div class="stat-label">Designers</div></div></div>
                <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div></div>
                <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div></div>
                <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div></div>
                <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div><div><div class="stat-number">${stats.totalSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div></div>
                <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-comments"></i></div><div><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div></div>`;
            setContent('statsGrid', statsHtml);
        }

        function renderOverviewTab() {
            const overviewHtml = `<div class="success"><h3><i class="fas fa-check-circle"></i> System Status: All Systems Operational</h3><p>Welcome to your SteelConnect admin panel.</p></div>`;
            setContent('overview-tab', overviewHtml);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`[onclick*="showTab('${tabName}')"]`).classList.add('active');
            
            const dataMap = { users: usersData, jobs: jobsData, quotes: quotesData, estimations: estimationsData, messages: messagesData, subscriptions: subscriptionsData };
            const loadMap = { users: loadUsersData, jobs: loadJobsData, quotes: loadQuotesData, estimations: loadEstimationsData, messages: loadMessagesData, subscriptions: loadSubscriptionsData, overview: renderOverviewTab };
            
            if (tabName !== 'overview' && dataMap[tabName].length === 0) {
                loadMap[tabName]();
            } else if (tabName === 'overview') {
                loadMap[tabName]();
            }
        }
        
        async function loadDataAndRender(tabId, endpoint, dataArrayName, renderFunc, dataKey) {
            const tabElementId = `${tabId}-tab`;
            setContent(tabElementId, loadingSpinner);
            try {
                console.log(`üîÑ Loading ${tabId} data...`);
                const response = await apiCall(endpoint);
                const data = response[dataKey] || response.data || [];
                window[dataArrayName] = data; // Assign to global variable
                renderFunc();
                console.log(`‚úÖ ${tabId} data loaded.`);
            } catch (error) {
                console.error(`‚ùå Error loading ${tabId}:`, error);
                setContent(tabElementId, loadingError(error.message));
            }
        }

        function loadUsersData() { loadDataAndRender('users', '/admin/users', 'usersData', renderUsersTab, 'data'); }
        function loadJobsData() { loadDataAndRender('jobs', '/admin/jobs', 'jobsData', renderJobsTab, 'data'); }
        function loadQuotesData() { loadDataAndRender('quotes', '/admin/quotes', 'quotesData', renderQuotesTab, 'data'); }
        function loadEstimationsData() { loadDataAndRender('estimations', '/admin/estimations', 'estimationsData', renderEstimationsTab, 'estimations'); }
        function loadMessagesData() { loadDataAndRender('messages', '/admin/messages', 'messagesData', renderMessagesTab, 'data'); }
        function loadSubscriptionsData() { /* special handling for multiple calls */ }

        function renderUsersTab() {
             if (!Array.isArray(usersData)) return setContent('users-tab', loadingError("Invalid data format for users."));
             const content = usersData.length === 0 ? '<div class="no-data">No users found</div>' : `<h3><i class="fas fa-users"></i> All Users (${usersData.length})</h3><table><thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Status</th><th>Joined</th></tr></thead><tbody>${usersData.map(u => `<tr><td><strong>${u.name||'N/A'}</strong></td><td>${u.email}</td><td><span class="user-type ${u.type}">${u.type}</span></td><td>${u.status||'Active'}</td><td>${new Date(u.createdAt).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
             setContent('users-tab', content);
        }

        function renderJobsTab() {
            if (!Array.isArray(jobsData)) return setContent('jobs-tab', loadingError("Invalid data format for jobs."));
            const content = jobsData.length === 0 ? '<div class="no-data">No jobs found</div>' : `<h3><i class="fas fa-briefcase"></i> All Jobs (${jobsData.length})</h3><table><thead>...</thead><tbody>...</tbody></table>`;
            setContent('jobs-tab', content);
        }

        function renderQuotesTab() {
            if (!Array.isArray(quotesData)) return setContent('quotes-tab', loadingError("Invalid data format for quotes."));
            const content = quotesData.length === 0 ? '<div class="no-data">No quotes found</div>' : `<h3><i class="fas fa-file-invoice-dollar"></i> All Quotes (${quotesData.length})</h3><table><thead>...</thead><tbody>...</tbody></table>`;
            setContent('quotes-tab', content);
        }

        function renderEstimationsTab() {
            if (!Array.isArray(estimationsData)) return setContent('estimations-tab', loadingError("Invalid data format for estimations."));
            const content = estimationsData.length === 0 ? '<div class="no-data">No estimations found</div>' : `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-calculator"></i> All Estimations (${estimationsData.length})</h3>
                    <button class="btn" onclick="loadEstimationsData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <table><thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Submitted</th><th>Actions</th></tr></thead>
                <tbody>${estimationsData.map(est => `
                    <tr>
                        <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                        <td>${est.contractorName || 'Unknown'}</td>
                        <td><span class="status-badge ${est.status}">${est.status}</span></td>
                        <td>${est.uploadedFiles?.length || 0}</td>
                        <td>${new Date(est.createdAt).toLocaleDateString()}</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm btn-warning" onclick="showEstimationFilesModal('${est._id}')" title="View/Download Files"><i class="fas fa-file-alt"></i></button>
                                <button class="btn btn-sm btn-info" onclick="viewEstimationMessages('${est._id}')" title="View Messages"><i class="fas fa-comments"></i></button>
                            </div>
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
            setContent('estimations-tab', content);
        }

        function renderMessagesTab() {
            if (!Array.isArray(messagesData)) return setContent('messages-tab', loadingError("Invalid data format for messages."));
            const content = messagesData.length === 0 ? '<div class="no-data">No conversations found</div>' : `...`;
            setContent('messages-tab', content);
        }

        // --- MODAL & ACTION FUNCTIONS ---
        function showEstimationFilesModal(estimationId) {
            const modal = document.getElementById('filesModal');
            if (!modal.innerHTML) modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Estimation Files</h3><span class="close" onclick="closeModal('filesModal')">&times;</span></div><div id="filesContent"></div></div>`;
            const content = document.getElementById('filesContent');
            modal.style.display = 'flex';

            const estimation = estimationsData.find(e => e._id === estimationId);
            if (!estimation || !estimation.uploadedFiles || estimation.uploadedFiles.length === 0) {
                content.innerHTML = '<div class="no-data">No files were uploaded for this estimation.</div>';
                return;
            }

            content.innerHTML = estimation.uploadedFiles.map(file => `
                <div class="file-list-item">
                    <div class="file-info-container"><i class="fas fa-file-alt"></i><span class="file-name">${file.name}</span></div>
                    <a href="${file.url}" download="${file.name}" class="download-link" target="_blank" rel="noopener noreferrer"><i class="fas fa-download"></i> Download</a>
                </div>`).join('');
        }

        async function viewEstimationMessages(estimationId) {
            const modal = document.getElementById('messagesModal');
            if (!modal.innerHTML) modal.innerHTML = `<div class="modal-content large"><div class="modal-header"><h3 id="messagesModalTitle"></h3><span class="close" onclick="closeModal('messagesModal')">&times;</span></div><div id="messagesContent"></div></div>`;
            
            document.getElementById('messagesModalTitle').textContent = 'Estimation Messages';
            const content = document.getElementById('messagesContent');
            modal.style.display = 'flex';
            content.innerHTML = loadingSpinner;
            try {
                const data = await apiCall(`/admin/estimations/${estimationId}/messages`);
                const messages = data.messages || [];
                if (messages.length === 0) {
                    content.innerHTML = '<div class="no-data">No messages found for this estimation.</div>';
                    return;
                }
                content.innerHTML = `<div class="messages-container">${messages.map(msg => `<div class="message"><div class="message-header">${msg.senderName || 'Unknown'}<span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span></div><div class="message-text">${msg.text || ''}</div></div>`).join('')}</div>`;
            } catch (error) {
                content.innerHTML = loadingError(error.message);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) modal.style.display = 'none';
            });
        }
    </script>
</body>
</html>
