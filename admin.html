<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <div class="header-actions">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Loading...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading"><div class="spinner"></div><p>Loading dashboard statistics...</p></div>
        </div>

        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('users')"><i class="fas fa-users"></i> Users</button>
                <button class="tab" onclick="showTab('jobs')"><i class="fas fa-briefcase"></i> Jobs</button>
                <button class="tab" onclick="showTab('quotes')"><i class="fas fa-file-invoice-dollar"></i> Quotes</button>
                <button class="tab" onclick="showTab('estimations')"><i class="fas fa-calculator"></i> Estimations</button>
                <button class="tab" onclick="showTab('messages')"><i class="fas fa-comments"></i> Messages</button>
            </div>
            
            <div id="users-tab" class="tab-content active"><div class="loading"><div class="spinner"></div><p>Loading users...</p></div></div>
            <div id="jobs-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading jobs...</p></div></div>
            <div id="quotes-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading quotes...</p></div></div>
            <div id="estimations-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading estimations...</p></div></div>
            <div id="messages-tab" class="tab-content"><div class="loading"><div class="spinner"></div><p>Loading messages...</p></div></div>
        </div>
    </div>

    <div id="pdfUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Upload Estimation Result</h3><span class="close" onclick="closeModal('pdfUploadModal')">&times;</span></div>
            <form id="pdfUploadForm" enctype="multipart/form-data">
                <div class="form-group"><label for="estimationResultFile">Select Result File:</label><input type="file" id="estimationResultFile" name="resultFile" required></div>
                <div class="form-group"><label for="resultAmount">Estimated Amount ($):</label><input type="number" id="resultAmount" name="amount" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group"><label for="resultNotes">Additional Notes:</label><textarea id="resultNotes" name="notes" placeholder="Add notes about this estimation..."></textarea></div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('pdfUploadModal')">Cancel</button><button type="submit" class="btn btn-success"><i class="fas fa-upload"></i> Upload</button></div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let usersData = [], jobsData = [], quotesData = [], estimationsData = [], messagesData = [];
        let currentUploadEstimationId = null;

        // --- AUTH & API ---
        function getToken() {
            // Checks multiple common keys for the token for robustness
            return localStorage.getItem('adminToken') || localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            if (!token) {
                alert('Authentication error. Redirecting to login.');
                logout();
                throw new Error('No authentication token found');
            }
            
            const config = {
                headers: { 'Authorization': `Bearer ${token}` },
                ...options
            };
            
            // The browser sets the correct Content-Type for FormData automatically.
            if (options.body && !(options.body instanceof FormData)) {
                config.headers['Content-Type'] = 'application/json';
            }

            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                alert('Session expired. Please log in again.');
                logout();
                throw new Error('Authentication failed');
            }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'An unknown server error occurred' }));
                throw new Error(errorData.error || `HTTP Error: ${response.status}`);
            }
            return response.json();
        }

        // --- UI & TABS ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            document.querySelector(`.tab[onclick*="'${tabName}'"]`).classList.add('active');
            
            const dataLoaders = {
                users: loadUsersData,
                jobs: loadJobsData,
                quotes: loadQuotesData,
                estimations: loadEstimationsData,
                messages: loadMessagesData,
            };
            
            // Only load data if it hasn't been loaded before
            if (dataLoaders[tabName] && isDataEmpty(tabName)) {
                dataLoaders[tabName]();
            }
        }
        
        function isDataEmpty(dataType) {
            const dataMap = { users: usersData, jobs: jobsData, quotes: quotesData, estimations: estimationsData, messages: messagesData };
            return !dataMap[dataType] || dataMap[dataType].length === 0;
        }

        function showNotification(message, type = 'success') {
            alert(`[${type.toUpperCase()}] ${message}`);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- DATA RENDERING ---
        function renderStatsGrid(stats) {
            const grid = document.getElementById('statsGrid');
            const statItems = [
                { key: 'totalUsers', icon: 'users', label: 'Total Users' },
                { key: 'contractors', icon: 'hard-hat', label: 'Contractors' },
                { key: 'totalJobs', icon: 'briefcase', label: 'Total Jobs' },
                { key: 'totalQuotes', icon: 'file-invoice-dollar', label: 'Total Quotes' },
                { key: 'totalEstimations', icon: 'calculator', label: 'Estimations' },
                { key: 'totalMessages', icon: 'comments', label: 'Messages' }
            ];
            grid.innerHTML = statItems.map(item => `
                <div class="stat-card">
                    <div class="stat-icon ${item.key}"><i class="fas fa-${item.icon}"></i></div>
                    <div class="stat-number">${stats[item.key] || 0}</div>
                    <div class="stat-label">${item.label}</div>
                </div>`).join('');
        }

        function renderUsersTab() {
            const container = document.getElementById('users-tab');
            if (isDataEmpty('users')) {
                container.innerHTML = `<div class="no-data"><h3>No users found</h3></div>`; return;
            }
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Name / Company</th><th>Email</th><th>Type</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
                        <tbody>${usersData.map(user => {
                            const userType = user.type || user.role || 'user';
                            const isActive = user.isActive !== false;
                            const userId = user._id || user.id;
                            return `<tr>
                                <td><div class="user-info"><strong>${user.name}</strong><small>${user.company || 'N/A'}</small></div></td>
                                <td>${user.email}</td>
                                <td><span class="type-badge ${userType}">${userType}</span></td>
                                <td><span class="status-badge ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td><div class="action-group">
                                    <button class="btn btn-sm btn-warning" onclick="toggleUserStatus('${userId}', ${!isActive})" title="${isActive ? 'Deactivate' : 'Activate'}">
                                        <i class="fas fa-${isActive ? 'ban' : 'check'}"></i>
                                    </button>
                                </div></td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>`;
        }

        function renderEstimationsTab() {
            const container = document.getElementById('estimations-tab');
            if (isDataEmpty('estimations')) {
                container.innerHTML = `<div class="no-data"><h3>No estimations found</h3></div>`; return;
            }
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Submitted</th><th>Actions</th></tr></thead>
                        <tbody>${estimationsData.map(est => {
                            const estId = est._id || est.id;
                            return `<tr>
                                <td>${est.projectTitle || 'Untitled'}</td>
                                <td>${est.contractorName || 'Unknown'}</td>
                                <td><span class="status-badge ${est.status}">${est.status}</span></td>
                                <td>
                                    ${(est.uploadedFiles?.length || 0)} files
                                    ${(est.uploadedFiles?.length > 0) ? `<button class="btn btn-sm btn-secondary" onclick="downloadAllEstimationFiles('${estId}')" title="Download Files"><i class="fas fa-download"></i></button>` : ''}
                                </td>
                                <td>${new Date(est.createdAt).toLocaleDateString()}</td>
                                <td><div class="action-group">
                                    <button class="btn btn-sm btn-success" onclick="openUploadModal('${estId}')" title="Upload Result"><i class="fas fa-upload"></i></button>
                                    ${est.resultFile ? `<button class="btn btn-sm btn-info" onclick="downloadEstimationResult('${estId}')" title="Download Result"><i class="fas fa-file-download"></i></button>` : ''}
                                </div></td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>`;
        }

        // --- DATA LOADING & ACTIONS ---
        async function loadDashboardStats() {
            try {
                const response = await apiCall('/admin/dashboard');
                document.getElementById('adminName').textContent = response.data.adminUser?.split('@')[0] || 'Admin';
                renderStatsGrid(response.data.stats);
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = `<div class="error">Failed to load stats: ${error.message}</div>`;
            }
        }
        
        async function loadUsersData() { usersData = (await apiCall('/admin/users')).data; renderUsersTab(); }
        async function loadJobsData() { document.getElementById('jobs-tab').innerHTML = `<div class="no-data"><h3>Jobs data will be displayed here.</h3></div>`; }
        async function loadQuotesData() { document.getElementById('quotes-tab').innerHTML = `<div class="no-data"><h3>Quotes data will be displayed here.</h3></div>`; }
        async function loadMessagesData() { document.getElementById('messages-tab').innerHTML = `<div class="no-data"><h3>Messages data will be displayed here.</h3></div>`; }
        async function loadEstimationsData() { estimationsData = (await apiCall('/estimation')).estimations; renderEstimationsTab(); }

        /**
         * CORRECTED: Toggles user active status using the single, correct API endpoint.
         */
        async function toggleUserStatus(userId, newStatus) {
            const action = newStatus ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;
            try {
                await apiCall(`/admin/users/${userId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ isActive: newStatus })
                });
                showNotification(`User ${action}d successfully`, 'success');
                // Refresh data to show the change
                await loadUsersData();
            } catch (error) {
                showNotification(`Failed to update user status: ${error.message}`, 'error');
            }
        }

        // --- FILE HANDLING ---
        function openUploadModal(estimationId) {
            currentUploadEstimationId = estimationId;
            document.getElementById('pdfUploadForm').reset();
            document.getElementById('pdfUploadModal').style.display = 'block';
        }

        /**
         * REWRITTEN: Downloads all contractor files for a specific estimation.
         * Constructs the correct authenticated download URL and opens it.
         */
        function downloadAllEstimationFiles(estimationId) {
            const token = getToken();
            if (!token) { showNotification('Authentication error.', 'error'); return; }
            
            const estimation = estimationsData.find(e => (e._id || e.id) === estimationId);
            if (!estimation || !estimation.uploadedFiles || estimation.uploadedFiles.length === 0) {
                showNotification('No files found for this estimation.', 'warning');
                return;
            }

            showNotification(`Preparing to download ${estimation.uploadedFiles.length} file(s)...`, 'info');
            estimation.uploadedFiles.forEach((file, index) => {
                const url = `${API_BASE}/estimation/${estimationId}/files/${encodeURIComponent(file.name)}/download?token=${token}`;
                // Stagger downloads slightly to avoid browser popup blockers
                setTimeout(() => window.open(url, '_blank'), index * 300);
            });
        }

        /**
         * REWRITTEN: Downloads the admin-uploaded result file for an estimation.
         * Constructs the correct authenticated download URL and opens it.
         */
        function downloadEstimationResult(estimationId) {
            const token = getToken();
            if (!token) { showNotification('Authentication error.', 'error'); return; }
            
            const url = `${API_BASE}/estimation/${estimationId}/result/download?token=${token}`;
            window.open(url, '_blank');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!getToken()) {
                alert('You are not logged in. Redirecting to login page.');
                window.location.href = 'index.html';
                return;
            }
            loadDashboardStats();
            showTab('users'); // Load users tab by default

            // PDF Upload form handler
            document.getElementById('pdfUploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentUploadEstimationId) return;

                const formData = new FormData(this);
                try {
                    showNotification('Uploading...', 'info');
                    await apiCall(`/estimation/${currentUploadEstimationId}/result`, {
                        method: 'POST',
                        body: formData
                    });
                    showNotification('Result uploaded successfully!', 'success');
                    closeModal('pdfUploadModal');
                    // Refresh data to show the new result file button
                    await loadEstimationsData();
                } catch (error) {
                    showNotification(`Upload failed: ${error.message}`, 'error');
                }
            });
        });
    </script>
</body>
</html>
