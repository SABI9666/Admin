<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="notification-container"></div>
    <div id="modal-container"></div>
    
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <div class="header-actions">
                <div class="admin-badge">
                    <i class="fas fa-user-circle"></i>
                    <span id="adminName">Loading...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <div id="statsGrid" class="stats-grid"></div>

        <main class="section">
            <nav class="tabs">
                <button class="tab active" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab" onclick="showTab('profile-reviews')">
                    <i class="fas fa-user-check"></i> Profile Reviews
                </button>
            </nav>
            
            <div id="users-tab" class="tab-content active"></div>
            <div id="profile-reviews-tab" class="tab-content"></div>
        </main>
    </div>

    <script>
        console.log('Admin script starting...');
        
        // Basic variables
        const API_BASE_URL = 'https://steelconnect-backend.onrender.com';
        let currentUser = null;
        let authToken = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            initAdmin();
        });

        function initAdmin() {
            // Check authentication
            authToken = localStorage.getItem('jwtToken');
            const userStr = localStorage.getItem('currentUser');
            
            if (!authToken || !userStr) {
                console.log('No auth found');
                window.location.href = 'index.html';
                return;
            }

            try {
                currentUser = JSON.parse(userStr);
                if (currentUser.role !== 'admin') {
                    console.log('Not admin');
                    window.location.href = 'index.html';
                    return;
                }
            } catch (e) {
                console.log('User parse error');
                window.location.href = 'index.html';
                return;
            }

            // Set admin name
            document.getElementById('adminName').textContent = currentUser.name || currentUser.email;
            
            // Load data
            loadStats();
            loadUsers();
        }

        function showTab(tabName) {
            console.log('Switching to:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            const tab = document.getElementById(tabName + '-tab');
            const button = event.target.closest('.tab');
            
            if (tab) tab.classList.add('active');
            if (button) button.classList.add('active');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        async function apiCall(endpoint) {
            try {
                const response = await fetch(API_BASE_URL + '/api/admin' + endpoint, {
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('API call failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API error:', error);
                throw error;
            }
        }

        async function loadStats() {
            try {
                const data = await apiCall('/dashboard');
                const stats = data.stats || {};
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card"><h3>${stats.totalUsers || 0}</h3><p>Total Users</p></div>
                    <div class="stat-card"><h3>${stats.pendingProfileReviews || 0}</h3><p>Pending Reviews</p></div>
                    <div class="stat-card"><h3>${stats.totalJobs || 0}</h3><p>Total Jobs</p></div>
                    <div class="stat-card"><h3>${stats.totalQuotes || 0}</h3><p>Total Quotes</p></div>
                `;
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = '<p>Error loading stats</p>';
            }
        }

        async function loadUsers() {
            const container = document.getElementById('users-tab');
            container.innerHTML = '<p>Loading users...</p>';
            
            try {
                const data = await apiCall('/users');
                const users = data.users || [];
                
                container.innerHTML = `
                    <h3>Users (${users.length})</h3>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <tr style="background:#f5f5f5;">
                            <th style="padding:10px; border:1px solid #ddd;">Name</th>
                            <th style="padding:10px; border:1px solid #ddd;">Email</th>
                            <th style="padding:10px; border:1px solid #ddd;">Role</th>
                            <th style="padding:10px; border:1px solid #ddd;">Status</th>
                        </tr>
                        ${users.map(user => `
                            <tr>
                                <td style="padding:10px; border:1px solid #ddd;">${user.name || 'N/A'}</td>
                                <td style="padding:10px; border:1px solid #ddd;">${user.email || 'N/A'}</td>
                                <td style="padding:10px; border:1px solid #ddd;">${user.role || 'N/A'}</td>
                                <td style="padding:10px; border:1px solid #ddd;">${user.isActive ? 'Active' : 'Inactive'}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            } catch (error) {
                container.innerHTML = '<p style="color:red;">Error loading users</p>';
            }
        }

        console.log('Admin script loaded');
    </script>
</body>
</html>
