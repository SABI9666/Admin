<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            <div class="header-actions">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Loading...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard statistics...</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="tab" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab" onclick="showTab('jobs')">
                    <i class="fas fa-briefcase"></i> Jobs
                </button>
                <button class="tab" onclick="showTab('quotes')">
                    <i class="fas fa-file-invoice-dollar"></i> Quotes
                </button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                </button>
                <button class="tab" onclick="showTab('subscriptions')">
                    <i class="fas fa-credit-card"></i> Subscriptions
                </button>
            </div>
            
            <!-- Tab Contents -->
            <div id="overview-tab" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading overview data...</p>
                </div>
            </div>
            
            <div id="users-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading users data...</p>
                </div>
            </div>
            
            <div id="jobs-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading jobs data...</p>
                </div>
            </div>
            
            <div id="quotes-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading quotes data...</p>
                </div>
            </div>
            
            <div id="estimations-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading estimations data...</p>
                </div>
            </div>
            
            <div id="messages-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages data...</p>
                </div>
            </div>
            
            <div id="subscriptions-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading subscriptions data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Estimation Details Modal -->
    <div id="estimationDetailsModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Estimation Details</h3>
                <span class="close" onclick="closeModal('estimationDetailsModal')">&times;</span>
            </div>
            <div id="estimationDetailsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading estimation details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Messages Modal with Controls -->
    <div id="messagesControlModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Message Management</h3>
                <span class="close" onclick="closeModal('messagesControlModal')">&times;</span>
            </div>
            <div id="messageControlContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading message controls...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div id="replyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reply to Message</h3>
                <span class="close" onclick="closeModal('replyModal')">&times;</span>
            </div>
            <form id="replyForm">
                <div class="form-group">
                    <label for="replyRecipient">To:</label>
                    <input type="text" id="replyRecipient" readonly>
                </div>
                <div class="form-group">
                    <label for="replySubject">Subject:</label>
                    <input type="text" id="replySubject" readonly>
                </div>
                <div class="form-group">
                    <label for="replyMessage">Message:</label>
                    <textarea id="replyMessage" rows="6" placeholder="Type your reply here..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('replyModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Other existing modals remain unchanged -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Estimation Status</h3>
                <span class="close" onclick="closeModal('statusModal')">&times;</span>
            </div>
            <form id="statusForm">
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (Optional):</label>
                    <textarea id="statusNotes" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('statusModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Estimation Result</h3>
                <span class="close" onclick="closeModal('uploadResultModal')">&times;</span>
            </div>
            <form id="uploadResultForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Result File (PDF):</label>
                    <div class="file-upload-area" id="resultUploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                        <p>Click to select or drag and drop your result file here</p>
                        <input type="file" id="resultFile" accept=".pdf" style="display: none;">
                    </div>
                    <div id="uploadedResultFiles" class="uploaded-files"></div>
                </div>
                <div class="form-group">
                    <label for="estimationAmount">Estimated Amount ($):</label>
                    <input type="number" id="estimationAmount" step="0.01" placeholder="Enter estimation amount">
                </div>
                <div class="form-group">
                    <label for="resultNotes">Notes (Optional):</label>
                    <textarea id="resultNotes" placeholder="Add any notes about this estimation..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadResultModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Upload Result</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Subscription Plan</h3>
                <span class="close" onclick="closeModal('createPlanModal')">&times;</span>
            </div>
            <form id="createPlanForm">
                <div class="form-group">
                    <label for="planName">Plan Name:</label>
                    <input type="text" id="planName" required placeholder="e.g., Premium Plan">
                </div>
                <div class="form-group">
                    <label for="planPrice">Price ($):</label>
                    <input type="number" id="planPrice" step="0.01" required placeholder="29.99">
                </div>
                <div class="form-group">
                    <label for="planInterval">Billing Interval:</label>
                    <select id="planInterval" required>
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planDescription">Description:</label>
                    <textarea id="planDescription" placeholder="Plan description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Features:</label>
                    <div id="featuresContainer">
                        <div class="feature-input">
                            <input type="text" placeholder="Feature 1">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeFeature(this)">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addFeature()">
                        <i class="fas fa-plus"></i> Add Feature
                    </button>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createPlanModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Plan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('🗂️ SteelConnect Admin Dashboard loaded');
        
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let usersData = [];
        let jobsData = [];
        let quotesData = [];
        let estimationsData = [];
        let messagesData = [];
        let subscriptionsData = [];
        let subscriptionPlans = [];
        let currentEstimationId = null;
        let currentMessageId = null;
        
        // Get authentication token
        function getToken() {
            return localStorage.getItem('adminToken') || 
                   localStorage.getItem('token') || 
                   sessionStorage.getItem('adminToken');
        }
        
        // Make authenticated API call
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            
            if (!token) {
                throw new Error('No authentication token found');
            }
            
            const config = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                ...options
            };
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('token');
                sessionStorage.removeItem('adminToken');
                window.location.href = 'index.html';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // Load dashboard stats
        async function loadDashboardStats() {
            try {
                console.log('📊 Loading dashboard statistics...');
                
                const data = await apiCall('/admin/dashboard');
                dashboardData = data.data;
                
                console.log('✅ Dashboard data loaded:', dashboardData);
                
                // Update admin name
                const adminName = document.getElementById('adminName');
                if (adminName && dashboardData.adminUser) {
                    adminName.textContent = dashboardData.adminUser.split('@')[0];
                }
                
                // Render stats cards
                renderStatsGrid(dashboardData.stats);
                
            } catch (error) {
                console.error('❌ Error loading dashboard:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load dashboard: ${error.message}
                    </div>
                `;
            }
        }
        
        // Render stats grid
        function renderStatsGrid(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number">${stats.totalUsers || 0}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon contractors">
                        <i class="fas fa-hard-hat"></i>
                    </div>
                    <div class="stat-number">${stats.contractors || 0}</div>
                    <div class="stat-label">Contractors</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon designers">
                        <i class="fas fa-drafting-compass"></i>
                    </div>
                    <div class="stat-number">${stats.designers || 0}</div>
                    <div class="stat-label">Designers</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon jobs">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="stat-number">${stats.totalJobs || 0}</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon quotes">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-number">${stats.totalQuotes || 0}</div>
                    <div class="stat-label">Total Quotes</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon estimations">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="stat-number">${stats.totalEstimations || 0}</div>
                    <div class="stat-label">Estimations</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon subscriptions">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="stat-number">${stats.totalSubscriptions || 0}</div>
                    <div class="stat-label">Subscriptions</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon messages">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-number">${stats.totalMessages || 0}</div>
                    <div class="stat-label">Messages</div>
                </div>
            `;
        }
        
        // Show tab function
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = document.querySelector(`[onclick*="showTab('${tabName}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Load data if needed
            if (tabName === 'users' && usersData.length === 0) {
                loadUsersData();
            } else if (tabName === 'jobs' && jobsData.length === 0) {
                loadJobsData();
            } else if (tabName === 'quotes' && quotesData.length === 0) {
                loadQuotesData();
            } else if (tabName === 'estimations' && estimationsData.length === 0) {
                loadEstimationsData();
            } else if (tabName === 'messages' && messagesData.length === 0) {
                loadMessagesData();
            } else if (tabName === 'subscriptions' && subscriptionsData.length === 0) {
                loadSubscriptionsData();
            } else if (tabName === 'overview') {
                renderOverviewTab();
            }
        }

        // Enhanced estimation loading with PDF downloads and descriptions
        async function loadEstimationsData() {
            try {
                console.log('🧮 Loading estimations data...');
                const data = await apiCall('/estimation');
                estimationsData = data.estimations || [];
                console.log('✅ Estimations data loaded:', estimationsData.length, 'estimations');
                renderEstimationsTab();
            } catch (error) {
                console.error('❌ Error loading estimations:', error);
                document.getElementById('estimations-tab').innerHTML = `
                    <div class="error">Failed to load estimations: ${error.message}</div>
                `;
            }
        }
        
        // Enhanced estimations tab with PDF download and description view
        function renderEstimationsTab() {
            const estimationsTab = document.getElementById('estimations-tab');
            
            if (estimationsData.length === 0) {
                estimationsTab.innerHTML = '<div class="no-data">No estimations found</div>';
                return;
            }
            
            estimationsTab.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-calculator"></i> All Estimations (${estimationsData.length})</h3>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="refreshEstimations()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="exportEstimations()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project Title</th>
                                <th>Contractor</th>
                                <th>Status</th>
                                <th>Files</th>
                                <th>Amount</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estimationsData.map(estimation => `
                                <tr>
                                    <td>
                                        <div class="project-info">
                                            <strong>${estimation.projectTitle || 'Untitled'}</strong>
                                            <small>${estimation.projectType || 'General'}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="contractor-info">
                                            <strong>${estimation.contractorName || 'Unknown'}</strong>
                                            <small>${estimation.contractorEmail || 'N/A'}</small>
                                        </div>
                                    </td>
                                    <td><span class="status-badge ${estimation.status}">${estimation.status.toUpperCase()}</span></td>
                                    <td>${estimation.uploadedFiles?.length || 0} files</td>
                                    <td>${estimation.estimatedAmount ? '$' + estimation.estimatedAmount.toLocaleString() : 'Pending'}</td>
                                    <td>${estimation.createdAt ? new Date(estimation.createdAt).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <div class="action-group">
                                            <button class="btn btn-sm btn-info" onclick="viewEstimationDetails('${estimation._id}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="updateEstimationStatus('${estimation._id}')" title="Update Status">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="viewEstimationFiles('${estimation._id}')" title="View Files">
                                                <i class="fas fa-file"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="uploadEstimationResult('${estimation._id}')" title="Upload Result">
                                                <i class="fas fa-upload"></i>
                                            </button>
                                            ${estimation.status === 'completed' && estimation.resultFile ? 
                                                `<button class="btn btn-sm btn-download" onclick="downloadEstimationPDF('${estimation._id}')" title="Download PDF">
                                                    <i class="fas fa-download"></i>
                                                </button>` : ''
                                            }
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Enhanced estimation details with description viewing
        async function viewEstimationDetails(estimationId) {
            try {
                const data = await apiCall(`/estimation/${estimationId}`);
                const estimation = data.estimation;
                
                document.getElementById('estimationDetailsContent').innerHTML = `
                    <div class="estimation-details">
                        <div class="detail-header">
                            <div class="header-info">
                                <h4>${estimation.projectTitle}</h4>
                                <p class="project-type">${estimation.projectType || 'General Project'}</p>
                                <span class="status-badge ${estimation.status}">${estimation.status.toUpperCase()}</span>
                            </div>
                            <div class="header-meta">
                                <p><strong>Submitted:</strong> ${estimation.createdAt ? new Date(estimation.createdAt).toLocaleDateString() : 'N/A'}</p>
                                <p><strong>Amount:</strong> ${estimation.estimatedAmount ? '$' + estimation.estimatedAmount.toLocaleString() : 'Pending'}</p>
                            </div>
                        </div>
                        
                        <div class="detail-body">
                            <div class="detail-section">
                                <h5>Contractor Information</h5>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>Name:</label>
                                        <span>${estimation.contractorName || 'Unknown'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Email:</label>
                                        <span>${estimation.contractorEmail || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Company:</label>
                                        <span>${estimation.contractorCompany || 'Independent'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h5>Project Description</h5>
                                <div class="description-box">
                                    ${estimation.description || estimation.projectDescription || 'No description provided'}
                                </div>
                            </div>
                            
                            ${estimation.uploadedFiles?.length ? `
                                <div class="detail-section">
                                    <h5>Uploaded Files (${estimation.uploadedFiles.length})</h5>
                                    <div class="files-grid">
                                        ${estimation.uploadedFiles.map(file => `
                                            <div class="file-card">
                                                <div class="file-icon">
                                                    <i class="fas fa-file-${getFileIcon(file.type)}"></i>
                                                </div>
                                                <div class="file-info">
                                                    <strong>${file.name}</strong>
                                                    <small>${formatFileSize(file.size || 0)}</small>
                                                </div>
                                                <button class="btn btn-sm btn-primary" onclick="downloadFile('${file.url}', '${file.name}')">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${estimation.resultFile ? `
                                <div class="detail-section">
                                    <h5>Result File</h5>
                                    <div class="result-file-card">
                                        <div class="file-info">
                                            <i class="fas fa-file-pdf"></i>
                                            <span>Estimation Result PDF</span>
                                        </div>
                                        <button class="btn btn-primary" onclick="downloadEstimationPDF('${estimationId}')">
                                            <i class="fas fa-download"></i> Download PDF
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="detail-actions">
                            <button class="btn btn-secondary" onclick="closeModal('estimationDetailsModal')">Close</button>
                            <button class="btn btn-primary" onclick="updateEstimationStatus('${estimationId}')">Update Status</button>
                            ${!estimation.resultFile ? `
                                <button class="btn btn-success" onclick="uploadEstimationResult('${estimationId}')">Upload Result</button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('estimationDetailsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading estimation details:', error);
                alert('Failed to load estimation details: ' + error.message);
            }
        }

        // Download estimation PDF
        async function downloadEstimationPDF(estimationId) {
            try {
                const data = await apiCall(`/estimation/${estimationId}/result`);
                
                if (data.resultFile && data.resultFile.url) {
                    // Create a temporary link element
                    const link = document.createElement('a');
                    link.href = data.resultFile.url;
                    link.download = data.resultFile.name || `estimation-result-${estimationId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log('✅ PDF download initiated');
                } else {
                    alert('No result file available for this estimation.');
                }
                
            } catch (error) {
                console.error('❌ Error downloading PDF:', error);
                alert('Failed to download PDF: ' + error.message);
            }
        }

        // Enhanced messages loading and rendering
        async function loadMessagesData() {
            try {
                console.log('💬 Loading messages data...');
                const data = await apiCall('/admin/messages');
                messagesData = data.messages || [];
                console.log('✅ Messages data loaded:', messagesData.length, 'messages');
                renderMessagesTab();
            } catch (error) {
                console.error('❌ Error loading messages:', error);
                document.getElementById('messages-tab').innerHTML = `
                    <div class="error">Failed to load messages: ${error.message}</div>
                `;
            }
        }
        
        // Enhanced messages tab with control options
        function renderMessagesTab() {
            const messagesTab = document.getElementById('messages-tab');
            
            if (messagesData.length === 0) {
                messagesTab.innerHTML = '<div class="no-data">No messages found</div>';
                return;
            }
            
            messagesTab.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-comments"></i> Messages (${messagesData.length})</h3>
                    <div class="header-actions">
                        <div class="filter-group">
                            <select id="messageStatusFilter" onchange="filterMessages(this.value)">
                                <option value="">All Messages</option>
                                <option value="unread">Unread</option>
                                <option value="read">Read</option>
                                <option value="replied">Replied</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="refreshMessages()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="exportMessages()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="messages-container">
                    ${messagesData.map(message => `
                        <div class="message-card ${message.status || 'unread'}" data-message-id="${message._id}" data-status="${message.status || 'unread'}">
                            <div class="message-header">
                                <div class="sender-info">
                                    <div class="sender-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="sender-details">
                                        <strong>${message.senderName || 'Unknown Sender'}</strong>
                                        <small>${message.senderEmail || 'No email'}</small>
                                    </div>
                                </div>
                                <div class="message-meta">
                                    <span class="message-time">${message.createdAt ? new Date(message.createdAt).toLocaleDateString() : 'N/A'}</span>
                                    <span class="status-badge ${message.status || 'unread'}">${(message.status || 'unread').toUpperCase()}</span>
                                </div>
                            </div>
                            
                            <div class="message-content">
                                <h4>${message.subject || 'No Subject'}</h4>
                                <p class="message-preview">${(message.content || message.message || '').substring(0, 150)}${(message.content || message.message || '').length > 150 ? '...' : ''}</p>
                            </div>
                            
                            <div class="message-actions">
                                <button class="btn btn-sm btn-info" onclick="viewMessageDetails('${message._id}')" title="View Details">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="replyToMessage('${message._id}')" title="Reply">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="markAsRead('${message._id}')" title="Mark as Read">
                                    <i class="fas fa-envelope-open"></i> Read
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="archiveMessage('${message._id}')" title="Archive">
                                    <i class="fas fa-archive"></i> Archive
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMessage('${message._id}')" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Message control functions
        async function viewMessageDetails(messageId) {
            try {
                const message = messagesData.find(m => m._id === messageId);
                if (!message) {
                    alert('Message not found');
                    return;
                }
                
                document.getElementById('messageControlContent').innerHTML = `
                    <div class="message-details">
                        <div class="message-detail-header">
                            <div class="sender-section">
                                <div class="sender-avatar-large">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="sender-info-detailed">
                                    <h4>${message.senderName || 'Unknown Sender'}</h4>
                                    <p>${message.senderEmail || 'No email'}</p>
                                    <small>Sent: ${message.createdAt ? new Date(message.createdAt).toLocaleString() : 'N/A'}</small>
                                </div>
                            </div>
                            <div class="message-status-section">
                                <span class="status-badge ${message.status || 'unread'}">${(message.status || 'unread').toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <div class="message-subject">
                            <h3>${message.subject || 'No Subject'}</h3>
                        </div>
                        
                        <div class="message-full-content">
                            <div class="content-box">
                                ${(message.content || message.message || 'No content').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        ${message.attachments && message.attachments.length > 0 ? `
                            <div class="message-attachments">
                                <h4>Attachments (${message.attachments.length})</h4>
                                <div class="attachments-grid">
                                    ${message.attachments.map(attachment => `
                                        <div class="attachment-item">
                                            <i class="fas fa-paperclip"></i>
                                            <span>${attachment.name}</span>
                                            <button class="btn btn-sm btn-primary" onclick="downloadFile('${attachment.url}', '${attachment.name}')">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="message-control-actions">
                            <button class="btn btn-primary" onclick="replyToMessage('${messageId}')">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                            <button class="btn btn-warning" onclick="markAsRead('${messageId}')">
                                <i class="fas fa-envelope-open"></i> Mark as Read
                            </button>
                            <button class="btn btn-secondary" onclick="archiveMessage('${messageId}')">
                                <i class="fas fa-archive"></i> Archive
                            </button>
                            <button class="btn btn-danger" onclick="deleteMessage('${messageId}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('messagesControlModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error viewing message details:', error);
                alert('Failed to view message details: ' + error.message);
            }
        }

        async function replyToMessage(messageId) {
            try {
                const message = messagesData.find(m => m._id === messageId);
                if (!message) {
                    alert('Message not found');
                    return;
                }
                
                currentMessageId = messageId;
                document.getElementById('replyRecipient').value = `${message.senderName} <${message.senderEmail}>`;
                document.getElementById('replySubject').value = `Re: ${message.subject || 'No Subject'}`;
                document.getElementById('replyMessage').value = '';
                
                // Close other modals
                document.getElementById('messagesControlModal').style.display = 'none';
                
                // Open reply modal
                document.getElementById('replyModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error preparing reply:', error);
                alert('Failed to prepare reply: ' + error.message);
            }
        }

        async function markAsRead(messageId) {
            try {
                await apiCall(`/admin/messages/${messageId}/read`, {
                    method: 'PATCH'
                });
                
                // Update local data
                const message = messagesData.find(m => m._id === messageId);
                if (message) {
                    message.status = 'read';
                }
                
                renderMessagesTab();
                document.getElementById('messagesControlModal').style.display = 'none';
                
            } catch (error) {
                console.error('Error marking message as read:', error);
                alert('Failed to mark message as read: ' + error.message);
            }
        }

        async function archiveMessage(messageId) {
            try {
                await apiCall(`/admin/messages/${messageId}/archive`, {
                    method: 'PATCH'
                });
                
                // Update local data
                const message = messagesData.find(m => m._id === messageId);
                if (message) {
                    message.status = 'archived';
                }
                
                renderMessagesTab();
                document.getElementById('messagesControlModal').style.display = 'none';
                
            } catch (error) {
                console.error('Error archiving message:', error);
                alert('Failed to archive message: ' + error.message);
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/admin/messages/${messageId}`, {
                    method: 'DELETE'
                });
                
                // Remove from local data
                messagesData = messagesData.filter(m => m._id !== messageId);
                
                renderMessagesTab();
                document.getElementById('messagesControlModal').style.display = 'none';
                
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message: ' + error.message);
            }
        }

        function filterMessages(status) {
            const messageCards = document.querySelectorAll('.message-card');
            messageCards.forEach(card => {
                const messageStatus = card.dataset.status;
                const shouldShow = !status || messageStatus === status;
                card.style.display = shouldShow ? 'block' : 'none';
            });
        }

        // Utility functions
        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'pdf',
                'doc': 'word',
                'docx': 'word',
                'xls': 'excel',
                'xlsx': 'excel',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'zip': 'archive',
                'rar': 'archive'
            };
            return icons[fileType?.toLowerCase()] || 'file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load other data functions (keeping existing implementations)
        async function loadUsersData() {
            try {
                console.log('👥 Loading users data...');
                const data = await apiCall('/admin/users');
                usersData = data.data;
                console.log('✅ Users data loaded:', usersData.length, 'users');
                renderUsersTab();
            } catch (error) {
                console.error('❌ Error loading users:', error);
                document.getElementById('users-tab').innerHTML = `
                    <div class="error">Failed to load users: ${error.message}</div>
                `;
            }
        }

        function renderUsersTab() {
            const usersTab = document.getElementById('users-tab');
            
            if (usersData.length === 0) {
                usersTab.innerHTML = '<div class="no-data">No users found</div>';
                return;
            }
            
            usersTab.innerHTML = `
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> All Users (${usersData.length})</h3>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="exportUsers()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${usersData.map(user => `
                                <tr>
                                    <td><strong>${user.name || 'N/A'}</strong></td>
                                    <td>${user.email}</td>
                                    <td><span class="type-badge ${user.type}">${user.type.toUpperCase()}</span></td>
                                    <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                                    <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <div class="action-group">
                                            <button class="btn btn-sm btn-info" onclick="viewUserDetails('${user._id}')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="toggleUserStatus('${user._id}', ${!user.isActive})" title="${user.isActive ? 'Deactivate' : 'Activate'}">
                                                <i class="fas fa-${user.isActive ? 'user-slash' : 'user-check'}"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Placeholder functions for other tabs
        async function loadJobsData() {
            console.log('Loading jobs data...');
            // Implementation would go here
        }

        async function loadQuotesData() {
            console.log('Loading quotes data...');
            // Implementation would go here
        }

        async function loadSubscriptionsData() {
            console.log('Loading subscriptions data...');
            // Implementation would go here
        }

        function renderOverviewTab() {
            const overviewTab = document.getElementById('overview-tab');
            
            overviewTab.innerHTML = `
                <div class="overview-content">
                    <div class="welcome-section">
                        <h3>Welcome to SteelConnect Admin Dashboard</h3>
                        <p>Manage your platform efficiently with comprehensive tools and insights.</p>
                    </div>
                    
                    <div class="quick-stats">
                        <div class="stat-summary">
                            <h4>System Status</h4>
                            <div class="status-indicators">
                                <div class="status-item">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span>All Systems Operational</span>
                                </div>
                                <div class="status-item">
                                    <i class="fas fa-database text-success"></i>
                                    <span>Database Connected</span>
                                </div>
                                <div class="status-item">
                                    <i class="fas fa-cloud text-success"></i>
                                    <span>API Services Running</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal and utility functions
        function updateEstimationStatus(estimationId) {
            currentEstimationId = estimationId;
            const estimation = estimationsData.find(e => e._id === estimationId);
            
            if (estimation) {
                document.getElementById('statusSelect').value = estimation.status;
                document.getElementById('statusNotes').value = '';
                document.getElementById('statusModal').style.display = 'block';
            }
        }

        function viewEstimationFiles(estimationId) {
            const estimation = estimationsData.find(e => e._id === estimationId);
            if (estimation && estimation.uploadedFiles?.length > 0) {
                let filesList = 'Files for this estimation:\n\n';
                estimation.uploadedFiles.forEach((file, index) => {
                    filesList += `${index + 1}. ${file.name}\n`;
                });
                alert(filesList);
            } else {
                alert('No files found for this estimation.');
            }
        }

        function uploadEstimationResult(estimationId) {
            currentEstimationId = estimationId;
            document.getElementById('resultFile').value = '';
            document.getElementById('estimationAmount').value = '';
            document.getElementById('resultNotes').value = '';
            document.getElementById('uploadedResultFiles').innerHTML = '';
            document.getElementById('uploadResultModal').style.display = 'block';
        }

        function refreshEstimations() {
            estimationsData = [];
            loadEstimationsData();
        }

        function refreshMessages() {
            messagesData = [];
            loadMessagesData();
        }

        function addFeature() {
            const container = document.getElementById('featuresContainer');
            const featureDiv = document.createElement('div');
            featureDiv.className = 'feature-input';
            featureDiv.innerHTML = `
                <input type="text" placeholder="New feature">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeFeature(this)">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            container.appendChild(featureDiv);
        }

        function removeFeature(button) {
            button.parentElement.remove();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                console.log('👋 Logging out admin...');
                localStorage.removeItem('adminToken');
                localStorage.removeItem('token');
                localStorage.removeItem('adminUser');
                sessionStorage.removeItem('adminToken');
                window.location.href = 'index.html';
            }
        }

        // Form submissions
        document.addEventListener('DOMContentLoaded', function() {
            // Status Form
            document.getElementById('statusForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const status = document.getElementById('statusSelect').value;
                const notes = document.getElementById('statusNotes').value;
                
                try {
                    await apiCall(`/estimation/${currentEstimationId}/status`, {
                        method: 'PATCH',
                        body: JSON.stringify({ status, notes })
                    });
                    
                    const estimation = estimationsData.find(e => e._id === currentEstimationId);
                    if (estimation) {
                        estimation.status = status;
                    }
                    
                    renderEstimationsTab();
                    closeModal('statusModal');
                    alert('Estimation status updated successfully!');
                    
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('Failed to update status: ' + error.message);
                }
            });

            // Reply Form
            document.getElementById('replyForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const message = document.getElementById('replyMessage').value;
                
                try {
                    await apiCall(`/admin/messages/${currentMessageId}/reply`, {
                        method: 'POST',
                        body: JSON.stringify({ message })
                    });
                    
                    // Update message status
                    const msg = messagesData.find(m => m._id === currentMessageId);
                    if (msg) {
                        msg.status = 'replied';
                    }
                    
                    renderMessagesTab();
                    closeModal('replyModal');
                    alert('Reply sent successfully!');
                    
                } catch (error) {
                    console.error('Error sending reply:', error);
                    alert('Failed to send reply: ' + error.message);
                }
            });
        });

        // Click outside modal to close
        window.onclick = function(event) {
            const modals = ['statusModal', 'uploadResultModal', 'createPlanModal', 'estimationDetailsModal', 'messagesControlModal', 'replyModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing admin dashboard...');
            
            const token = getToken();
            
            if (!token) {
                console.log('❌ No authentication token found, redirecting to login...');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('✅ Authentication token found, loading dashboard...');
            loadDashboardStats();
            
            // Set up auto-refresh every 5 minutes
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    loadDashboardStats();
                }
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
