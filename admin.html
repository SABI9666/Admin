<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Ultra Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="animated-bg"></div>
    <div class="floating-orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
        <div class="orb orb3"></div>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="logo-container">
                <div class="logo">STEELCONNECT</div>
                <div class="logo-subtitle">Admin Portal</div>
            </div>
            <nav class="nav-menu">
                <button class="tab active" onclick="showTab('overview')"><i class="fas fa-home"></i> Overview</button>
                <button class="tab" onclick="showTab('users')"><i class="fas fa-users"></i> Users</button>
                <button class="tab" onclick="showTab('jobs')"><i class="fas fa-briefcase"></i> Jobs</button>
                <button class="tab" onclick="showTab('quotes')"><i class="fas fa-file-invoice-dollar"></i> Quotes</button>
                <button class="tab" onclick="showTab('estimations')"><i class="fas fa-calculator"></i> Estimations</button>
                <button class="tab" onclick="showTab('messages')"><i class="fas fa-comments"></i> Messages</button>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                <div class="header-actions">
                    <div class="admin-badge">
                        <i class="fas fa-user-shield"></i>
                        <span id="adminName">Admin</span>
                    </div>
                    <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <div class="stats-grid" id="statsGrid">
                </div>

            <section class="section">
                <h2 id="section-title"><i class="fas fa-chart-bar"></i> Management Portal</h2>
                <div id="overview-tab" class="tab-content active"></div>
                <div id="users-tab" class="tab-content"></div>
                <div id="jobs-tab" class="tab-content"></div>
                <div id="quotes-tab" class="tab-content"></div>
                <div id="estimations-tab" class="tab-content"></div>
                <div id="messages-tab" class="tab-content"></div>
            </section>
        </main>
    </div>

    <div id="filesModal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                <h3 id="filesModalTitle">Estimation Files</h3>
                <button class="close" onclick="closeModal('filesModal')">&times;</button>
            </div>
            <div id="filesModalContent" class="files-list-container">
                </div>
        </div>
    </div>

    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="messagesModalHeader">
                </div>
            <div id="messagesContent"></div>
            <div class="message-reply-box">
                <textarea class="message-input" id="replyMessage" placeholder="Type your admin reply..."></textarea>
                <button class="btn btn-success" onclick="sendReply()"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let currentTab = 'overview';
        let currentConversationId = null;

        // --- CORE FUNCTIONS ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        function getToken() {
            return localStorage.getItem('adminToken') || localStorage.getItem('token');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            if (!token) {
                alert("Authentication token not found. Please log in.");
                window.location.href = 'index.html';
                return;
            }
            const config = {
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                ...options
            };
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                if (response.status === 401) {
                    alert("Your session has expired or is invalid. Please log in again.");
                    logout();
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP Error: ${response.status}` }));
                    throw new Error(errorData.message);
                }
                if (response.status === 204) { return null; }
                return await response.json();
            } catch (error) {
                console.error(`API Call Error to ${endpoint}:`, error);
                throw error;
            }
        }

        function initializeApp() {
            if (!getToken()) {
                window.location.href = 'index.html'; // Redirect if not logged in
                return;
            }
            loadDashboardStats();
            showTab('overview');
        }

        // --- UI RENDERING ---
        function getLoadingHtml() { return '<div class="loading"><div class="spinner"></div><p>Loading data...</p></div>'; }
        function getErrorHtml(message) { return `<div class="error">Failed to load data: ${message}</div>`; }
        function getNoDataHtml(message) { return `<div class="no-data">${message}</div>`; }

        async function loadDashboardStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = getLoadingHtml();
            try {
                const data = await apiCall('/admin/dashboard');
                dashboardData = data.data;
                document.getElementById('adminName').textContent = dashboardData.adminUser ? dashboardData.adminUser.split('@')[0] : 'Admin';
                renderStatsGrid(dashboardData.stats);
            } catch (error) {
                statsGrid.innerHTML = getErrorHtml(error.message);
            }
        }

        function renderStatsGrid(stats = {}) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div></div>
                <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div></div>
                <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div></div>
                <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div></div>
            `;
        }
        
        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.add('active');
            activeTab.innerHTML = getLoadingHtml();
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            const actions = {
                'overview': renderOverviewTab,
                'users': () => loadAndRenderData('users-tab', '/admin/users', renderUsersTable, 'data'),
                'jobs': () => loadAndRenderData('jobs-tab', '/jobs', renderJobsTable, 'data'),
                'quotes': () => loadAndRenderData('quotes-tab', '/quotes', renderQuotesTable, 'data'),
                'estimations': () => loadAndRenderData('estimations-tab', '/estimation', renderEstimationsTable, 'estimations'),
                'messages': () => loadAndRenderData('messages-tab', '/messages', renderMessagesList, 'data')
            };
            if(actions[tabName]) actions[tabName]();
        }
        
        async function loadAndRenderData(containerId, endpoint, renderer, dataKey) {
            const container = document.getElementById(containerId);
            try {
                const response = await apiCall(endpoint);
                const items = response[dataKey] || [];
                if (items.length === 0) {
                    container.innerHTML = getNoDataHtml(`No ${dataKey} found.`);
                    return;
                }
                container.innerHTML = renderer(items);
            } catch (error) {
                container.innerHTML = getErrorHtml(error.message);
            }
        }
        
        function renderOverviewTab() {
            const container = document.getElementById('overview-tab');
            if (!dashboardData?.stats) {
                container.innerHTML = getNoDataHtml('Overview data not available.');
                return;
            }
            container.innerHTML = `<div class="success"><h3><i class="fas fa-check-circle"></i> System Status: Operational</h3></div>`;
        }
        
        // --- TABLE RENDERERS ---
        function renderUsersTable(users) {
            return `<h3>All Users (${users.length})</h3><table><thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Joined</th></tr></thead><tbody>
            ${users.map(u => `<tr><td><strong>${u.name}</strong></td><td>${u.email}</td><td><span class="user-type ${u.type}">${u.type}</span></td><td>${new Date(u.createdAt).toLocaleDateString()}</td></tr>`).join('')}
            </tbody></table>`;
        }

        function renderJobsTable(jobs) {
            return `<h3>All Jobs (${jobs.length})</h3><table><thead><tr><th>Title</th><th>Poster</th><th>Status</th><th>Created</th></tr></thead><tbody>
            ${jobs.map(j => `<tr><td><strong>${j.title}</strong></td><td>${j.posterName || 'N/A'}</td><td><span class="status-badge ${j.status}">${j.status}</span></td><td>${new Date(j.createdAt).toLocaleDateString()}</td></tr>`).join('')}
            </tbody></table>`;
        }
        
        function renderQuotesTable(quotes) {
             return `<h3>All Quotes (${quotes.length})</h3><table><thead><tr><th>Job Title</th><th>Designer</th><th>Amount</th><th>Status</th></tr></thead><tbody>
            ${quotes.map(q => `<tr><td><strong>${q.jobTitle}</strong></td><td>${q.designerName}</td><td>$${q.quoteAmount}</td><td><span class="status-badge ${q.status}">${q.status}</span></td></tr>`).join('')}
            </tbody></table>`;
        }

        function renderEstimationsTable(estimations) {
            return `<h3>All Estimations (${estimations.length})</h3><table><thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Date</th><th>Actions</th></tr></thead><tbody>
            ${estimations.map(est => `<tr>
                <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                <td>${est.contractorName || 'Unknown'}</td>
                <td><span class="status-badge ${est.status}">${est.status}</span></td>
                <td>${est.uploadedFiles?.length || 0}</td>
                <td>${new Date(est.createdAt).toLocaleDateString()}</td>
                <td><div class="actions">
                    <button class="btn btn-sm btn-info" title="View Files" onclick="viewEstimationFiles('${est._id}')"><i class="fas fa-folder-open"></i></button>
                    <button class="btn btn-sm btn-success" title="Download All Files" onclick="downloadEstimationFiles('${est._id}')"><i class="fas fa-download"></i></button>
                </div></td>
            </tr>`).join('')}
            </tbody></table>`;
        }

        function renderMessagesList(conversations) {
            return `<h3>Conversations (${conversations.length})</h3><div class="conversation-list">
            ${conversations.map(c => `<div class="conversation-item" onclick="viewConversation('${c.id}')">
                <div class="conversation-header"><div class="conversation-title">${c.jobTitle || 'General Inquiry'}</div><div class="conversation-time">${new Date(c.updatedAt.seconds * 1000).toLocaleDateString()}</div></div>
                <p class="conversation-preview"><strong>Last:</strong> ${c.lastMessage || 'No messages yet'}</p>
            </div>`).join('')}
            </div>`;
        }

        // --- FEATURE FUNCTIONS ---
        async function downloadEstimationFiles(estimationId) {
            try {
                // CORRECTED: Fetch from the /files endpoint to get the file list.
                const data = await apiCall(`/estimation/${estimationId}/files`);
                const files = data.files || [];
                if (files.length === 0) {
                    alert('No files found for this estimation.');
                    return;
                }
                alert(`Starting download for ${files.length} file(s).`);
                for (const file of files) {
                    if (file.url) {
                        const link = document.createElement('a');
                        link.href = file.url;
                        link.download = file.name || 'downloaded-file';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }
            } catch (error) {
                alert(`Failed to download files: ${error.message}`);
            }
        }
        
        async function viewEstimationFiles(estimationId) {
             try {
                const data = await apiCall(`/estimation/${estimationId}/files`);
                const files = data.files || [];
                const modalContent = document.getElementById('filesModalContent');
                if (files.length === 0) {
                    modalContent.innerHTML = getNoDataHtml('No files are attached to this estimation.');
                } else {
                    modalContent.innerHTML = files.map(file => `
                        <div class="file-item">
                            <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="file-details">
                                <span class="file-name">${file.name}</span>
                                <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                            </div>
                            <a href="${file.url}" target="_blank" download="${file.name}" class="btn btn-sm btn-info"><i class="fas fa-download"></i> Download</a>
                        </div>
                    `).join('');
                }
                openModal('filesModal');
            } catch (error) {
                alert(`Failed to load files: ${error.message}`);
            }
        }

        async function viewConversation(conversationId) {
            currentConversationId = conversationId;
            openModal('messagesModal');
            document.getElementById('messagesModalHeader').innerHTML = `<h3>Conversation</h3><div class="header-buttons"><button class="btn btn-sm btn-danger" onclick="deleteConversation('${conversationId}')"><i class="fas fa-trash"></i> Delete All</button><button class="close" onclick="closeModal('messagesModal')">&times;</button></div>`;
            const contentArea = document.getElementById('messagesContent');
            contentArea.innerHTML = getLoadingHtml();
            try {
                const response = await apiCall(`/messages/${conversationId}/messages`);
                const messages = response.data || [];
                if (messages.length === 0) {
                    contentArea.innerHTML = getNoDataHtml('No messages in this conversation.');
                } else {
                    contentArea.innerHTML = `<div class="messages-container">${messages.map(msg => `
                        <div class="message">
                            <div class="message-header">
                                <div><strong>${msg.senderName}</strong><span class="message-time">${new Date(msg.createdAt.seconds * 1000).toLocaleString()}</span></div>
                                <button class="btn-delete-msg" title="Delete Message" onclick="deleteMessage('${msg.id}')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="message-text">${msg.text}</div>
                        </div>`).join('')}</div>`;
                    contentArea.querySelector('.messages-container').scrollTop = contentArea.querySelector('.messages-container').scrollHeight;
                }
            } catch (error) {
                contentArea.innerHTML = getErrorHtml(error.message);
            }
        }

        async function sendReply() {
            const input = document.getElementById('replyMessage');
            const text = input.value.trim();
            if (!text || !currentConversationId) return;
            try {
                await apiCall(`/messages/${currentConversationId}/send`, { method: 'POST', body: JSON.stringify({ text }) });
                input.value = '';
                viewConversation(currentConversationId);
            } catch (error) { alert(`Failed to send reply: ${error.message}`); }
        }
        
        async function deleteMessage(messageId) {
            if (!confirm('Permanently delete this message?')) return;
            try {
                // NOTE: This assumes your backend has a DELETE endpoint like this.
                await apiCall(`/messages/delete/${messageId}`, { method: 'DELETE' });
                alert('Message deleted.');
                viewConversation(currentConversationId);
            } catch (error) { alert(`Failed to delete message: ${error.message}.\nYour backend might not support this specific action.`); }
        }
        
        async function deleteConversation(conversationId) {
            if (!confirm('Permanently delete this entire conversation? This cannot be undone.')) return;
            try {
                await apiCall(`/messages/${conversationId}`, { method: 'DELETE' });
                alert('Conversation deleted.');
                closeModal('messagesModal');
                loadTabData('messages');
            } catch (error) { alert(`Failed to delete conversation: ${error.message}`); }
        }
        
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    </script>
</body>
</html>
