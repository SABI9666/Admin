<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            <div class="header-actions">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Loading...</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard statistics...</p>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-chart-bar"></i> Management Portal</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="fas fa-home"></i> Overview
                </button>
                <button class="tab" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab" onclick="showTab('jobs')">
                    <i class="fas fa-briefcase"></i> Jobs
                </button>
                <button class="tab" onclick="showTab('quotes')">
                    <i class="fas fa-file-invoice-dollar"></i> Quotes
                </button>
                <button class="tab" onclick="showTab('estimations')">
                    <i class="fas fa-calculator"></i> Estimations
                </button>
                <button class="tab" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i> Messages
                </button>
                <button class="tab" onclick="showTab('subscriptions')">
                    <i class="fas fa-credit-card"></i> Subscriptions
                </button>
            </div>
            
            <div id="overview-tab" class="tab-content active">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading overview data...</p>
                </div>
            </div>
            
            <div id="users-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading users data...</p>
                </div>
            </div>
            
            <div id="jobs-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading jobs data...</p>
                </div>
            </div>
            
            <div id="quotes-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading quotes data...</p>
                </div>
            </div>
            
            <div id="estimations-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading estimations data...</p>
                </div>
            </div>
            
            <div id="messages-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages data...</p>
                </div>
            </div>
            
            <div id="subscriptions-tab" class="tab-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading subscriptions data...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Estimation Status</h3>
                <span class="close" onclick="closeAndRemoveModal(this.closest('.modal'))">&times;</span>
            </div>
            <form id="statusForm">
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" required>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusNotes">Notes (Optional):</label>
                    <textarea id="statusNotes" placeholder="Add any notes about this status change..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAndRemoveModal(this.closest('.modal'))">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Estimation Result</h3>
                <span class="close" onclick="closeAndRemoveModal(this.closest('.modal'))">&times;</span>
            </div>
            <form id="uploadResultForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Result File (PDF):</label>
                    <div class="file-upload-area" id="resultUploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                        <p>Click to select or drag and drop your result file here</p>
                        <input type="file" id="resultFile" accept=".pdf" style="display: none;">
                    </div>
                    <div id="uploadedResultFiles" class="uploaded-files"></div>
                </div>
                <div class="form-group">
                    <label for="estimationAmount">Estimated Amount ($):</label>
                    <input type="number" id="estimationAmount" step="0.01" placeholder="Enter estimation amount">
                </div>
                <div class="form-group">
                    <label for="resultNotes">Notes (Optional):</label>
                    <textarea id="resultNotes" placeholder="Add any notes about this estimation..."></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAndRemoveModal(this.closest('.modal'))">Cancel</button>
                    <button type="submit" class="btn btn-success">Upload Result</button>
                </div>
            </form>
        </div>
    </div>

    <div id="createPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Subscription Plan</h3>
                <span class="close" onclick="closeAndRemoveModal(this.closest('.modal'))">&times;</span>
            </div>
            <form id="createPlanForm">
                <div class="form-group">
                    <label for="planName">Plan Name:</label>
                    <input type="text" id="planName" required placeholder="e.g., Premium Plan">
                </div>
                <div class="form-group">
                    <label for="planPrice">Price ($):</label>
                    <input type="number" id="planPrice" step="0.01" required placeholder="29.99">
                </div>
                <div class="form-group">
                    <label for="planInterval">Billing Interval:</label>
                    <select id="planInterval" required>
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planDescription">Description:</label>
                    <textarea id="planDescription" placeholder="Plan description..."></textarea>
                </div>
                <div class="form-group">
                    <label>Features:</label>
                    <div id="featuresContainer">
                        <div class="feature-input">
                            <input type="text" placeholder="Feature 1">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeFeature(this)">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addFeature()">
                        <i class="fas fa-plus"></i> Add Feature
                    </button>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeAndRemoveModal(this.closest('.modal'))">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Plan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Conversation Messages</h3>
                <span class="close" onclick="closeAndRemoveModal(this.closest('.modal'))">&times;</span>
            </div>
            <div id="messagesContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🏗️ SteelConnect Admin Dashboard loaded');
        
        const API_BASE = 'https://steelconnect-backend.onrender.com/api';
        let dashboardData = {};
        let usersData = [];
        let jobsData = [];
        let quotesData = [];
        let estimationsData = [];
        let messagesData = [];
        let subscriptionsData = [];
        let subscriptionPlans = [];
        let currentEstimationId = null;
        
        // --- UTILITY FUNCTIONS ---

        // Get authentication token
        function getToken() {
            return localStorage.getItem('adminToken') || 
                   localStorage.getItem('token') || 
                   sessionStorage.getItem('adminToken');
        }

        // Format Date String Safely
        function formatDateString(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                // Try parsing Firestore timestamp format as a fallback
                if (dateStr._seconds) {
                    const firestoreDate = new Date(dateStr._seconds * 1000);
                    if (!isNaN(firestoreDate.getTime())) {
                        return firestoreDate.toLocaleDateString();
                    }
                }
                return 'Invalid Date';
            }
            return date.toLocaleDateString();
        }

        // Download File Helper
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', filename);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Modal Controls
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function closeAndRemoveModal(modalElement) {
             if (modalElement) {
                modalElement.remove();
            }
        }

        // Make authenticated API call
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            
            if (!token) {
                throw new Error('No authentication token found');
            }
            
            const config = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                ...options
            };
            
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = 'index.html';
                return;
            }
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.message || `HTTP ${response.status}`);
            }
            
            return await response.json();
        }
        
        // --- CORE LOGIC ---

        // Load dashboard stats
        async function loadDashboardStats() {
            try {
                const data = await apiCall('/admin/dashboard');
                dashboardData = data.data;
                const adminName = document.getElementById('adminName');
                if (adminName && dashboardData.adminUser) {
                    adminName.textContent = dashboardData.adminUser.split('@')[0];
                }
                renderStatsGrid(dashboardData.stats);
            } catch (error) {
                console.error('❌ Error loading dashboard:', error);
                document.getElementById('statsGrid').innerHTML = `<div class="error">Failed to load dashboard: ${error.message}</div>`;
            }
        }
        
        // Render stats grid
        function renderStatsGrid(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-number">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div>
                <div class="stat-card"><div class="stat-icon contractors"><i class="fas fa-hard-hat"></i></div><div class="stat-number">${stats.contractors || 0}</div><div class="stat-label">Contractors</div></div>
                <div class="stat-card"><div class="stat-icon designers"><i class="fas fa-drafting-compass"></i></div><div class="stat-number">${stats.designers || 0}</div><div class="stat-label">Designers</div></div>
                <div class="stat-card"><div class="stat-icon jobs"><i class="fas fa-briefcase"></i></div><div class="stat-number">${stats.totalJobs || 0}</div><div class="stat-label">Total Jobs</div></div>
                <div class="stat-card"><div class="stat-icon quotes"><i class="fas fa-file-invoice-dollar"></i></div><div class="stat-number">${stats.totalQuotes || 0}</div><div class="stat-label">Total Quotes</div></div>
                <div class="stat-card"><div class="stat-icon estimations"><i class="fas fa-calculator"></i></div><div class="stat-number">${stats.totalEstimations || 0}</div><div class="stat-label">Estimations</div></div>
                <div class="stat-card"><div class="stat-icon subscriptions"><i class="fas fa-credit-card"></i></div><div class="stat-number">${stats.totalSubscriptions || 0}</div><div class="stat-label">Subscriptions</div></div>
                <div class="stat-card"><div class="stat-icon messages"><i class="fas fa-comments"></i></div><div class="stat-number">${stats.totalMessages || 0}</div><div class="stat-label">Messages</div></div>
            `;
        }
        
        // Show tab function
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick*="'${tabName}'"]`).classList.add('active');
            
            const loadMap = {
                users: { data: usersData, loader: loadUsersData },
                jobs: { data: jobsData, loader: loadJobsData },
                quotes: { data: quotesData, loader: loadQuotesData },
                estimations: { data: estimationsData, loader: loadEstimationsData },
                messages: { data: messagesData, loader: loadMessagesData },
                subscriptions: { data: subscriptionsData, loader: loadSubscriptionsData },
            };

            if (tabName in loadMap && loadMap[tabName].data.length === 0) {
                loadMap[tabName].loader();
            } else if (tabName === 'overview') {
                renderOverviewTab();
            }
        }
        
        // Load estimations data
        async function loadEstimationsData() {
            try {
                const data = await apiCall('/estimation');
                estimationsData = data.estimations || [];
                renderEstimationsTab();
            } catch (error) {
                document.getElementById('estimations-tab').innerHTML = `<div class="error">Failed to load estimations: ${error.message}</div>`;
            }
        }
        
        // Render estimations tab
        function renderEstimationsTab() {
            const estimationsTab = document.getElementById('estimations-tab');
            if (estimationsData.length === 0) {
                estimationsTab.innerHTML = '<div class="no-data">No estimations found</div>';
                return;
            }
            estimationsTab.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-calculator"></i> All Estimations (${estimationsData.length})</h3>
                    <button class="btn" onclick="loadEstimationsData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Project Title</th><th>Contractor</th><th>Status</th><th>Files</th><th>Amount</th><th>Submitted</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${estimationsData.map(est => `
                            <tr>
                                <td><strong>${est.projectTitle || 'Untitled'}</strong></td>
                                <td>${est.contractorName || 'Unknown'}</td>
                                <td><span class="status-badge ${est.status}">${est.status.toUpperCase()}</span></td>
                                <td>${est.uploadedFiles?.length || 0} files</td>
                                <td>${est.estimatedAmount ? '$' + est.estimatedAmount.toLocaleString() : 'Pending'}</td>
                                <td>${formatDateString(est.createdAt)}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-sm" onclick="updateEstimationStatus('${est._id}')" title="Update Status"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-sm btn-warning" onclick="viewEstimationFiles('${est._id}')" title="View Contractor Files"><i class="fas fa-file-alt"></i></button>
                                        <button class="btn btn-sm btn-success" onclick="uploadEstimationResult('${est._id}')" title="Upload Result"><i class="fas fa-upload"></i></button>
                                        <button class="btn btn-sm btn-secondary" onclick="viewEstimationMessages('${est._id}')" title="View Messages"><i class="fas fa-comments"></i></button>
                                        ${est.resultFile ? `<button class="btn btn-sm btn-info" onclick="downloadResult('${est._id}')" title="Download Result"><i class="fas fa-download"></i></button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // CORRECTED: View estimation files from contractor
        async function viewEstimationFiles(estimationId) {
            try {
                const data = await apiCall(`/estimation/${estimationId}/files`);
                const files = data.files || [];

                if (files.length === 0) {
                    alert('No files have been uploaded for this estimation.');
                    return;
                }

                const filesHtml = files.map(file => `
                    <div class="file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px;">
                        <div>
                            <i class="fas fa-file" style="margin-right: 10px;"></i>
                            <span>${file.name}</span>
                        </div>
                        <button class="btn btn-sm btn-info" onclick="downloadFile('${file.url}', '${file.name}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                `).join('');

                const modalId = 'viewFilesModal';
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Uploaded Contractor Files</h3>
                            <span class="close" onclick="closeAndRemoveModal(this.closest('.modal'))">&times;</span>
                        </div>
                        <div style="padding: 20px;">${filesHtml}</div>
                    </div>
                `;
                document.body.appendChild(modal);

            } catch (error) {
                console.error('Error viewing estimation files:', error);
                alert('Failed to load estimation files: ' + error.message);
            }
        }
        
        // Load messages data
        async function loadMessagesData() {
            try {
                const data = await apiCall('/messages');
                messagesData = data.data || [];
                renderMessagesTab();
            } catch (error) {
                document.getElementById('messages-tab').innerHTML = `<div class="error">Failed to load messages: ${error.message}</div>`;
            }
        }
        
        // CORRECTED: Render messages tab with robust date handling
        function renderMessagesTab() {
            const messagesTab = document.getElementById('messages-tab');
            if (messagesData.length === 0) {
                messagesTab.innerHTML = '<div class="no-data">No conversations found</div>';
                return;
            }
            messagesTab.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-comments"></i> Conversations (${messagesData.length})</h3>
                    <button class="btn" onclick="loadMessagesData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div class="conversation-list">
                    ${messagesData.map(conv => `
                        <div class="conversation-item" onclick="viewConversation('${conv.id}')">
                            <div class="conversation-header">
                                <div class="conversation-title">${conv.jobTitle || 'Unknown Job'}</div>
                                <div class="conversation-time">${formatDateString(conv.updatedAt)}</div>
                            </div>
                            <div class="conversation-preview">
                                <strong>Participants:</strong> ${conv.participants?.map(p => p.name).join(', ') || 'Unknown'}
                            </div>
                            <div class="conversation-preview">
                                <strong>Last message:</strong> ${conv.lastMessage || 'No messages yet'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Load subscriptions data
        async function loadSubscriptionsData() {
            try {
                const [subscriptionsResponse, plansResponse] = await Promise.all([
                    apiCall('/admin/subscriptions'),
                    apiCall('/admin/subscription-plans')
                ]);
                subscriptionsData = subscriptionsResponse.subscriptions || [];
                subscriptionPlans = plansResponse.plans || [];
                renderSubscriptionsTab();
            } catch (error) {
                document.getElementById('subscriptions-tab').innerHTML = `<div class="error">Failed to load subscriptions: ${error.message}</div>`;
            }
        }

        // Render subscriptions tab
        function renderSubscriptionsTab() {
            const subscriptionsTab = document.getElementById('subscriptions-tab');
            subscriptionsTab.innerHTML = `
                <div class="subscriptions-management">
                    <div class="control-panel">
                        <h3><i class="fas fa-cogs"></i> System Controls</h3>
                        <div class="control-item">
                            <div class="control-info"><h4>Jobs Module</h4><p>Enable or disable job posting and management</p></div>
                            <label class="toggle-switch"><input type="checkbox" id="jobsToggle" checked onchange="toggleSystemFeature('jobs', this.checked)"><span class="toggle-slider"></span></label>
                        </div>
                        <div class="control-item">
                            <div class="control-info"><h4>User Registration</h4><p>Allow new users to register on the platform</p></div>
                            <label class="toggle-switch"><input type="checkbox" id="usersToggle" checked onchange="toggleSystemFeature('users', this.checked)"><span class="toggle-slider"></span></label>
                        </div>
                        <div class="control-item">
                            <div class="control-info"><h4>Messaging System</h4><p>Enable or disable user messaging functionality</p></div>
                            <label class="toggle-switch"><input type="checkbox" id="messagesToggle" checked onchange="toggleSystemFeature('messages', this.checked)"><span class="toggle-slider"></span></label>
                        </div>
                        <div class="control-item">
                            <div class="control-info"><h4>Estimation Requests</h4><p>Allow contractors to submit estimation requests</p></div>
                            <label class="toggle-switch"><input type="checkbox" id="estimationsToggle" checked onchange="toggleSystemFeature('estimations', this.checked)"><span class="toggle-slider"></span></label>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- OTHER FUNCTIONS (UNCHANGED) ---
        // Placeholder for other data loading functions
        async function loadUsersData() { document.getElementById('users-tab').innerHTML = '<div class="no-data">Users module coming soon.</div>'; }
        async function loadJobsData() { document.getElementById('jobs-tab').innerHTML = '<div class="no-data">Jobs module coming soon.</div>'; }
        async function loadQuotesData() { document.getElementById('quotes-tab').innerHTML = '<div class="no-data">Quotes module coming soon.</div>'; }
        function renderOverviewTab() { document.getElementById('overview-tab').innerHTML = '<h3>Dashboard Overview</h3><p>Key metrics and system status will be displayed here.</p>'; }
        
        async function viewEstimationMessages(estimationId) { alert(`Functionality to view messages for estimation ${estimationId} is being implemented.`); }
        async function downloadResult(estimationId) {
             try {
               const data = await apiCall(`/estimation/${estimationId}/result`);
               if (data.resultFile && data.resultFile.url) {
                   downloadFile(data.resultFile.url, data.resultFile.name || 'estimation-result.pdf');
               } else {
                   alert('No result file available for this estimation.');
               }
           } catch (error) {
               alert('Failed to download result: ' + error.message);
           }
        }
        async function viewConversation(conversationId) { alert(`Functionality to view conversation ${conversationId} is being implemented.`); }
        async function toggleSystemFeature(feature, enabled) {
            try {
                await apiCall(`/admin/system/toggle/${feature}`, { method: 'PATCH', body: JSON.stringify({ enabled }) });
                alert(`${feature} has been ${enabled ? 'enabled' : 'disabled'} successfully!`);
            } catch (error) {
                alert(`Failed to toggle ${feature}: ${error.message}`);
                document.getElementById(`${feature}Toggle`).checked = !enabled;
            }
        }
        function updateEstimationStatus(id){ alert(`Update status for ${id}`); document.getElementById('statusModal').style.display='block'; }
        function uploadEstimationResult(id){ alert(`Upload result for ${id}`); document.getElementById('uploadResultModal').style.display='block'; }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Event listener for initialization
        document.addEventListener('DOMContentLoaded', function() {
            if (!getToken()) {
                window.location.href = 'index.html';
                return;
            }
            loadDashboardStats().then(() => renderOverviewTab());
        });
    </script>
</body>
</html>
