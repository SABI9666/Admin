<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteelConnect - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background-color: #f5f7fa;
            --sidebar-bg: #1e293b;
            --sidebar-text: #cbd5e1;
            --sidebar-active: #ffffff;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --text-color: #334155;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
        }
        .login-prompt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        .login-prompt-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
            max-width: 400px; width: 90%;
        }
        .login-prompt-box h2 { font-size: 24px; margin-bottom: 10px; }
        .login-prompt-box p { color: #64748b; }
        .login-prompt-box .btn {
            width: 100%; padding: 15px; background: var(--primary-color);
            border-radius: 8px; border: none; font-size: 16px;
            display: inline-flex; justify-content: center; align-items: center;
            gap: 8px; color: white; cursor: pointer; transition: background 0.3s;
        }
        .login-prompt-box .btn:hover { background: var(--secondary-color); }
        .login-prompt-box .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        #admin-panel-container { display: flex; height: 100vh; overflow: hidden; }
        .admin-sidebar {
            width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 20px; transition: width 0.3s;
        }
        .admin-sidebar-header { text-align: center; margin-bottom: 30px; }
        .admin-sidebar-header .logo { font-size: 28px; font-weight: bold; color: white; }
        .admin-sidebar-header .admin-tag { font-size: 12px; color: var(--primary-color); }
        .admin-nav .admin-nav-link {
            display: flex; align-items: center; padding: 12px 15px; color: var(--sidebar-text);
            text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.3s;
        }
        .admin-nav .admin-nav-link i { margin-right: 15px; width: 20px; text-align: center; }
        .admin-nav .admin-nav-link:hover { background: #334155; color: var(--sidebar-active); }
        .admin-nav .admin-nav-link.active { background: var(--primary-color); color: var(--sidebar-active); font-weight: 600; }
        .admin-main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .admin-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: var(--header-bg); border-bottom: 1px solid var(--border-color);
        }
        .admin-header h1 { font-size: 24px; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .admin-badge { display: flex; align-items: center; gap: 10px; }
        #admin-content-area { padding: 30px; overflow-y: auto; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .loading-spinner { text-align: center; padding: 60px; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { background: white; border-radius: 8px; box-shadow: var(--shadow); overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: #f8fafc; font-weight: 600; }
        .data-table tbody tr:hover { background: #f1f5f9; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; color: white; display: inline-block; }
        .status-badge.pending, .status-badge.needed { background: #ffc107; color: #333; }
        .status-badge.completed, .status-badge.active { background: #28a745; }
        .status-badge.inactive, .status-badge.rejected { background: #dc3545; }
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 10001; }
        .notification { padding: 15px 20px; border-radius: 8px; box-shadow: var(--shadow); color: white; margin-bottom: 10px; }
        .notification.notification-success { background: #28a745; }
        .notification.notification-error { background: #dc3545; }
        .notification.notification-info { background: #17a2b8; }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body class="admin-body">

    <!-- Admin Panel (Initially Hidden) -->
    <div id="admin-panel-container" style="display: none;">
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <div class="logo">SteelConnect</div>
                <span class="admin-tag">Admin Panel</span>
            </div>
            <nav class="admin-nav">
                <a href="#" class="admin-nav-link active" data-section="estimations">
                    <i class="fas fa-calculator fa-fw"></i> Estimations
                </a>
                <a href="#" class="admin-nav-link" data-section="users">
                    <i class="fas fa-users fa-fw"></i> Users
                </a>
                 <a href="#" class="admin-nav-link" data-section="jobs">
                    <i class="fas fa-briefcase fa-fw"></i> Jobs
                </a>
                <a href="#" class="admin-nav-link" data-section="quotes">
                    <i class="fas fa-file-invoice-dollar fa-fw"></i> Quotes
                </a>
            </nav>
        </aside>

        <main class="admin-main-content">
            <header class="admin-header">
                <h1 id="admin-section-title">Estimations</h1>
                <div class="header-actions">
                     <div class="admin-badge">
                        <i class="fas fa-user-shield"></i>
                        <span id="admin-name">Admin</span>
                    </div>
                    <button id="admin-logout-btn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>
            <div id="admin-content-area" class="admin-content-area">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Login Form -->
    <div id="login-form-container" class="login-prompt-container">
        <div class="login-prompt-box">
            <form id="admin-login-form">
                <i class="fas fa-shield-alt" style="font-size: 48px; color: #667eea; margin-bottom: 20px;"></i>
                <h2>Admin Login</h2>
                <p style="margin-bottom: 25px;">Please enter your credentials to continue.</p>
                <div style="text-align: left; margin-bottom: 15px;">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;">
                </div>
                <div style="text-align: left; margin-bottom: 25px;">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;">
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Notification & Modal Containers -->
    <div id="notification-container" class="notification-container"></div>
    <div id="upload-result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Estimation Result</h3>
                <span class="close" onclick="window.closeModal()">&times;</span>
            </div>
            <form id="upload-result-form">
                <input type="hidden" id="upload-estimation-id">
                <div class="form-group">
                    <label for="resultFile">Result File (PDF, DOCX, etc.)</label>
                    <input type="file" id="resultFile" name="resultFile" required>
                </div>
                <div class="form-group">
                    <label for="estimatedAmount">Estimated Amount ($)</label>
                    <input type="number" id="estimatedAmount" name="amount" placeholder="e.g., 15000.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="adminNotes">Notes for Contractor</label>
                    <textarea id="adminNotes" name="notes" rows="3" placeholder="Add any notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Upload Result
                    </button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration ---
    const API_BASE_URL = 'https://steelconnect-backend.onrender.com/api';
    let currentData = { users: [], estimations: [], jobs: [], quotes: [] };

    // --- DOM Elements ---
    const loginContainer = document.getElementById('login-form-container');
    const adminPanel = document.getElementById('admin-panel-container');
    const contentArea = document.getElementById('admin-content-area');
    const sectionTitle = document.getElementById('admin-section-title');
    const navLinks = document.querySelectorAll('.admin-nav-link');

    // --- Core Functions ---
    const showNotification = (message, type = 'info') => {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    };

    const apiCall = async (endpoint, method = 'GET', body = null, isFormData = false) => {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginView();
            throw new Error('No token');
        }

        const options = {
            method,
            headers: { 'Authorization': `Bearer ${token}` },
        };

        if (body) {
            if (isFormData) {
                options.body = body;
            } else {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (response.status === 401) {
             showNotification('Session expired. Please log in again.', 'error');
             showLoginView();
             throw new Error('Unauthorized');
        }
        const responseData = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(responseData.error || responseData.message || 'An API error occurred');
        }
        return responseData;
    };
    
    const showLoginView = () => {
        localStorage.removeItem('adminToken');
        loginContainer.style.display = 'flex';
        adminPanel.style.display = 'none';
    };

    const showAdminView = (section = 'estimations') => {
        loginContainer.style.display = 'none';
        adminPanel.style.display = 'flex';
        renderSection(section);
    };

    // --- Rendering Functions ---
    const renderSection = (section) => {
        navLinks.forEach(link => link.classList.toggle('active', link.dataset.section === section));
        const sectionName = section.charAt(0).toUpperCase() + section.slice(1);
        sectionTitle.textContent = sectionName;

        const renderMap = {
            estimations: renderEstimations,
            users: renderUsers,
            jobs: renderJobs,
            quotes: renderQuotes
        };
        if (renderMap[section]) renderMap[section]();
    };

    const renderEstimations = async () => {
        contentArea.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        try {
            const data = await apiCall('/admin/estimations');
            currentData.estimations = data.estimations || [];
            if (currentData.estimations.length === 0) {
                contentArea.innerHTML = '<h3>No estimation requests found.</h3>';
                return;
            }
            contentArea.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>Project</th><th>Contractor</th><th>Status</th><th>Files</th><th>Result</th><th>Actions</th></tr></thead>
                        <tbody>${currentData.estimations.map(est => `
                            <tr>
                                <td>${est.projectTitle}</td>
                                <td>${est.contractorName}<br><small>${est.contractorEmail}</small></td>
                                <td><span class="status-badge ${est.status}">${est.status}</span></td>
                                <td>${est.uploadedFiles?.length > 0 ? `<button class="btn btn-sm btn-info" onclick="window.downloadFiles('${est._id}')"><i class="fas fa-download"></i> ${est.uploadedFiles.length} File(s)</button>` : 'No files'}</td>
                                <td>${est.resultFile ? `<span class="status-badge completed">Uploaded</span>` : `<span class="status-badge pending">Needed</span>`}</td>
                                <td><button class="btn btn-sm btn-success" onclick="window.openUploadModal('${est._id}')"><i class="fas fa-upload"></i> Upload Result</button></td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>`;
        } catch (error) { contentArea.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; }
    };
    
    const renderUsers = async () => {
        contentArea.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        try {
            const data = await apiCall('/admin/users');
            currentData.users = data.data || [];
            contentArea.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                         <thead><tr><th>Name</th><th>Email</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                         <tbody>${currentData.users.map(user => `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td>${user.type}</td>
                                <td><span class="status-badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                                <td><button class="btn btn-sm" onclick="window.toggleUserStatus('${user._id}', ${!user.isActive})">${user.isActive ? 'Deactivate' : 'Activate'}</button></td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>`;
        } catch (error) { contentArea.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; }
    };

    const renderJobs = async () => {
        contentArea.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
         try {
            const data = await apiCall('/admin/jobs');
            currentData.jobs = data.data || [];
            contentArea.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                         <thead><tr><th>Title</th><th>Client</th><th>Assigned To</th><th>Status</th><th>Budget</th></tr></thead>
                         <tbody>${currentData.jobs.map(job => `
                            <tr>
                                <td>${job.title}</td>
                                <td>${job.clientName}</td>
                                <td>${job.contractorName || 'Unassigned'}</td>
                                <td><span class="status-badge ${job.status}">${job.status}</span></td>
                                <td>${job.budget}</td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>`;
        } catch (error) { contentArea.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; }
    };

    const renderQuotes = async () => {
        contentArea.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
        try {
            const data = await apiCall('/admin/quotes');
            currentData.quotes = data.data || [];
            contentArea.innerHTML = `
                 <div class="table-container">
                    <table class="data-table">
                         <thead><tr><th>Project</th><th>Client</th><th>Amount</th><th>Status</th></tr></thead>
                         <tbody>${currentData.quotes.map(quote => `
                            <tr>
                                <td>${quote.projectTitle}</td>
                                <td>${quote.clientName}</td>
                                <td>$${quote.amount || 'N/A'}</td>
                                <td><span class="status-badge ${quote.status}">${quote.status}</span></td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>`;
        } catch (error) { contentArea.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; }
    };

    // --- Event Handlers & Global Functions ---
    document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div>';
        try {
            const response = await fetch(`${API_BASE_URL}/auth/login/admin`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: form.email.value, password: form.password.value }),
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Login failed');
            localStorage.setItem('adminToken', data.token);
            document.getElementById('admin-name').textContent = data.user.name || 'Admin';
            showNotification('Login successful!', 'success');
            showAdminView();
        } catch (error) { 
            showNotification(error.message, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        }
    });

    document.getElementById('admin-logout-btn').addEventListener('click', showLoginView);
    navLinks.forEach(link => link.addEventListener('click', (e) => {
        e.preventDefault();
        renderSection(link.dataset.section);
    }));
    
    window.downloadFiles = async (estimationId) => {
        try {
            const data = await apiCall(`/admin/estimations/${estimationId}/files`);
            if (!data.files || data.files.length === 0) return showNotification('No files found.', 'info');
            data.files.forEach(file => {
                const a = document.createElement('a'); a.href = file.url; a.target = '_blank'; a.download = file.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            });
        } catch (error) { showNotification(`Download failed: ${error.message}`, 'error'); }
    };

    window.openUploadModal = (estimationId) => {
        document.getElementById('upload-result-form').reset();
        document.getElementById('upload-estimation-id').value = estimationId;
        document.getElementById('upload-result-modal').style.display = 'flex';
    };
    
    window.closeModal = () => document.getElementById('upload-result-modal').style.display = 'none';
    
    document.getElementById('upload-result-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = this, estimationId = form['upload-estimation-id'].value;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        try {
            const formData = new FormData(form);
            await apiCall(`/admin/estimations/${estimationId}/result`, 'POST', formData, true);
            showNotification('Result uploaded successfully!', 'success');
            closeModal();
            renderEstimations();
        } catch (error) {
            showNotification(`Upload failed: ${error.message}`, 'error');
        } finally {
            submitButton.disabled = false;
        }
    });

    window.toggleUserStatus = async (userId, newStatus) => {
        try {
            await apiCall(`/admin/users/${userId}/status`, 'PATCH', { isActive: newStatus });
            showNotification('User status updated!', 'success');
            renderUsers();
        } catch(error) { showNotification(`Update failed: ${error.message}`, 'error'); }
    };

    // --- Initial Check ---
    if (localStorage.getItem('adminToken')) { showAdminView(); } else { showLoginView(); }
});
</script>
</body>
</html>
